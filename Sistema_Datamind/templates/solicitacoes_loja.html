<!-- 


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√µes de Loja</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        .header .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header a {
            text-decoration: none;
            color: white;
            padding: 8px 15px;
            border-radius: 3px;
            font-weight: bold;
        }
        .header a.sair {
            background-color: #e74c3c;
        }
        .header a.sair:hover {
            background-color: #c0392b;
        }
        .header a.home {
            background-color: #2ecc71;
        }
        .header a.home:hover {
            background-color: #27ae60;
        }
        .header .notification {
            position: relative;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .header .notification .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .notification-panel {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .filters {
            background-color: white;
            padding: 15px;
            margin: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filters label {
            font-weight: bold;
            color: #333;
        }
        .filters select, .filters input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 150px;
        }
        .filters input[type="number"] {
            width: 80px;
        }
        .filters input[type="text"].descricao {
            width: 200px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            background-color: #007bff;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .content {
            margin: 20px;
        }
        .content p {
            margin: 0 0 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #333;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .descricao-box {
            display: none;
            margin: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .descricao-box input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .descricao-box textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .descricao-box .box-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .descricao-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .descricao-box button.enviar {
            background-color: #28a745;
        }
        .descricao-box button.enviar:hover {
            background-color: #218838;
        }
        .descricao-box button.cancelar {
            background-color: #dc3545;
        }
        .descricao-box button.cancelar:hover {
            background-color: #c82333;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .popup input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .popup textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .popup .popup-buttons {
            display: flex;
            justify-content: space-between;
        }
        .popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .popup button.enviar {
            background-color: #28a745;
        }
        .popup button.enviar:hover {
            background-color: #218838;
        }
        .popup button.responder {
            background-color: #17a2b8;
        }
        .popup button.responder:hover {
            background-color: #138496;
        }
        .popup button.sair {
            background-color: #dc3545;
        }
        .popup button.sair:hover {
            background-color: #c82333;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        td button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        td button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Solicita√ß√µes de Loja</h1>
        <div class="nav-buttons">
            <span class="notification" onclick="toggleNotifications()">üîî<span class="badge" id="notification-badge">0</span></span>
            <a href="#" class="sair">Sair</a>
            <a href="#" class="home">Home</a>
        </div>
    </div>

    <div class="filters">
        <label for="filial">Filial:</label>
        <select id="filial" name="filial">
            <option value="">Selecione a Filial</option>
            <option value="1">1 | PONTA NEGRA</option>
            <option value="2">2 | ALECRIM</option>
            <option value="7">7 | SAC - CENTRO VI</option>
            <option value="100">100 | LAGOA NOVA</option>
            <option value="121">121 | NORTE SHOPPING</option>
            <option value="122">122 | PARNAMIRIM</option>
            <option value="137">137 | MACAIBA</option>
            <option value="131">131 | ZN2</option>
            <option value="140">140 | MARIA LACERDA</option>
            <option value="141">141 | IGAPO</option>
        </select>

        <label for="tipo_solicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipo_solicitacao" name="tipo_solicitacao">
            <option value="">Selecione o Tipo</option>
            <option value="aguas">√Åguas</option>
            <option value="panfletos">Panfletos Promocionais</option>
            <option value="ajustes">Ajustes de Pedidos</option>
            <option value="outros">Outros</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1">

        <label for="descricao">Descri√ß√£o:</label>
        <input type="text" id="descricao" name="descricao" class="descricao" placeholder="Clique para detalhar" onclick="toggleDescricaoBox()">

        <button onclick="window.print()">Imprimir</button>
        <button onclick="exportarExcel()">Abrir em Excel</button>
    </div>

    <div class="descricao-box" id="descricao-box">
        <input type="text" id="descricao-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="descricao-textarea" placeholder="Digite sua solicita√ß√£o..."></textarea>
        <div class="box-buttons">
            <button class="enviar" onclick="enviarDescricao()">Enviar</button>
            <button class="cancelar" onclick="toggleDescricaoBox()">Cancelar</button>
        </div>
    </div>

    <div class="content">
        <p>Solicita√ß√µes pendentes para o dep√≥sito:</p>
        <table>
            <thead>
                <tr>
                    <th>N√∫mero da Solicita√ß√£o</th>
                    <th>Filial</th>
                    <th>Tipo de Solicita√ß√£o</th>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Data/Hora</th>
                    <th>Matr√≠cula</th>
                    <th>Nome do Usu√°rio</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-solicitacoes">
                -- Solicita√ß√µes ser√£o adicionadas dinamicamente via JavaScript -
            </tbody>
        </table>
    </div>

    <div class="notification-panel" id="notification-panel"></div>
    <div class="overlay" id="overlay" onclick="fecharPopup()"></div>
    <div class="popup" id="popup">
        <input type="text" id="popup-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="popup-textarea" placeholder="Digite sua solicita√ß√£o ou resposta..."></textarea>
        <div class="popup-buttons">
            <button class="enviar" onclick="enviarPopup()">Enviar</button>
            <button class="responder" onclick="responderPopup()">Responder</button>
            <button class="sair" onclick="fecharPopup()">Sair</button>
        </div>
    </div>

    <script>
        let currentRow = null;
        let notificationCount = 0;
        let solicitacoes = []; // Armazenar as solicita√ß√µes com suas descri√ß√µes

        function updateNotificationCount() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let count = tabela.rows.length; // Uma notifica√ß√£o por solicita√ß√£o criada

            for (let row of tabela.rows) {
                const status = row.cells[8].innerText;
                const index = row.rowIndex;
                const solicitacao = solicitacoes[index];
                if (solicitacao && solicitacao.descricao.includes('Resposta:')) {
                    const respostas = (solicitacao.descricao.match(/Resposta:/g) || []).length;
                    count += respostas; // Incrementa para cada resposta
                }
                if (status !== 'Pendente') {
                    count++; // Incrementa para cada mudan√ßa de status
                }
            }

            notificationCount = count;
            document.getElementById('notification-badge').innerText = notificationCount;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const tabela = document.getElementById('tabela-solicitacoes');
            panel.innerHTML = '';

            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                return;
            }

            for (let row of tabela.rows) {
                const numero = row.cells[0].innerText;
                const status = row.cells[8].innerText;
                const index = row.rowIndex;
                const solicitacao = solicitacoes[index];
                let notificacao = `<div class="notification-item">Solicita√ß√£o #${numero}<br>Solicita√ß√£o enviada</div>`;

                if (solicitacao && solicitacao.descricao.includes('Resposta:')) {
                    const respostas = solicitacao.descricao.match(/Resposta: (.*?)( - \d{2}:\d{2}:\d{2})/g) || [];
                    for (let resposta of respostas) {
                        const textoResposta = resposta.match(/Resposta: (.*?)( - \d{2}:\d{2}:\d{2})/)[1];
                        notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Resposta recebida: ${textoResposta}</div>`;
                    }
                }

                if (status !== 'Pendente') {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Status alterado para ${status}</div>`;
                }

                panel.innerHTML += notificacao;
            }

            panel.classList.add('show');
        }

        function toggleDescricaoBox() {
            const box = document.getElementById('descricao-box');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if (box.style.display === 'block') {
                document.getElementById('descricao-titulo').value = '';
                document.getElementById('descricao-textarea').value = '';
            }
        }

        function enviarDescricao() {
            const titulo = document.getElementById('descricao-titulo').value.trim();
            const descricao = document.getElementById('descricao-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por Favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }
            document.getElementById('descricao').value = titulo;
            adicionarSolicitacao(titulo, descricao);
            toggleDescricaoBox();
        }

        function abrirPopup(action, row = null) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'block';
            overlay.style.display = 'block';

            if (row) {
                const index = row.rowIndex;
                const solicitacao = solicitacoes[index];
                if (solicitacao) {
                    document.getElementById('popup-titulo').value = solicitacao.titulo;
                    document.getElementById('popup-textarea').value = solicitacao.descricao;
                } else {
                    document.getElementById('popup-titulo').value = '';
                    document.getElementById('popup-textarea').value = '';
                }
            } else {
                document.getElementById('popup-titulo').value = '';
                document.getElementById('popup-textarea').value = '';
            }

            if (action === 'novo') {
                currentRow = null;
            } else if (action === 'ver') {
                currentRow = row;
            }
        }

        function fecharPopup() {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('popup-titulo').value = '';
            document.getElementById('popup-textarea').value = '';
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.getElementById('popup').style.display === 'block') {
                fecharPopup();
            }
        });

        function enviarPopup() {
            const titulo = document.getElementById('popup-titulo').value.trim();
            const descricao = document.getElementById('popup-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }
            if (currentRow) {
                const index = currentRow.rowIndex;
                solicitacoes[index] = { titulo, descricao };
            }
            fecharPopup();
        }

        function responderPopup() {
            const resposta = prompt('Digite sua resposta:');
            if (resposta) {
                if (currentRow) {
                    const index = currentRow.rowIndex;
                    const solicitacao = solicitacoes[index];
                    solicitacao.descricao += `\nResposta: ${resposta} - ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}`;
                    solicitacoes[index] = solicitacao;
                    updateNotificationCount();
                } else {
                    alert('Selecione uma solicita√ß√£o para responder.');
                }
                fecharPopup();
            }
        }

        function adicionarSolicitacao(titulo, descricao) {
            const filial = document.getElementById('filial').value;
            const tipoSolicitacao = document.getElementById('tipo_solicitacao').value;
            const quantidade = document.getElementById('quantidade').value;

            if (!filial || !tipoSolicitacao || !quantidade || !titulo) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            const filialNome = document.querySelector(`#filial option[value="${filial}"]`).text;
            const dataHora = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            const matricula = '12345';
            const nomeUsuario = 'Usu√°rio Exemplo';
            const numeroSolicitacao = Math.floor(Math.random() * 1000000);
            const status = 'Pendente';

            const tabela = document.getElementById('tabela-solicitacoes');
            const novaLinha = tabela.insertRow();
            novaLinha.innerHTML = `
                <td>${numeroSolicitacao}</td>
                <td>${filialNome}</td>
                <td>${tipoSolicitacao}</td>
                <td><button onclick="abrirPopup('ver', this.parentNode.parentNode)">Ver Obs</button></td>
                <td>${quantidade}</td>
                <td>${dataHora}</td>
                <td>${matricula}</td>
                <td>${nomeUsuario}</td>
                <td>${status}</td>
            `;

            solicitacoes[novaLinha.rowIndex] = { titulo, descricao };

            document.getElementById('filial').value = '';
            document.getElementById('tipo_solicitacao').value = '';
            document.getElementById('quantidade').value = '';
            document.getElementById('descricao').value = '';

            updateNotificationCount();
        }

        function exportarExcel() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let csv = 'N√∫mero da Solicita√ß√£o,Filial,Tipo de Solicita√ß√£o,Descri√ß√£o,Quantidade,Data/Hora,Matr√≠cula,Nome do Usu√°rio,Status\n';
            for (let row of tabela.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText.replace(/,/g, ';'));
                }
                csv += rowData.join(',') + '\n';
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solicitacoes.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

 -->





<!-- 


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√µes de Loja</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        .header .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header a {
            text-decoration: none;
            color: white;
            padding: 8px 15px;
            border-radius: 3px;
            font-weight: bold;
        }
        .header a.sair {
            background-color: #e74c3c;
        }
        .header a.sair:hover {
            background-color: #c0392b;
        }
        .header a.home {
            background-color: #2ecc71;
        }
        .header a.home:hover {
            background-color: #27ae60;
        }
        .header .notification {
            position: relative;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .header .notification .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .notification-panel {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .filters {
            background-color: white;
            padding: 15px;
            margin: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filters label {
            font-weight: bold;
            color: #333;
        }
        .filters select, .filters input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 150px;
        }
        .filters input[type="number"] {
            width: 80px;
        }
        .filters input[type="text"].descricao {
            width: 200px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            background-color: #007bff;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .content {
            margin: 20px;
        }
        .content p {
            margin: 0 0 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #333;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .descricao-box {
            display: none;
            margin: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .descricao-box input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .descricao-box textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .descricao-box .box-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .descricao-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .descricao-box button.enviar {
            background-color: #28a745;
        }
        .descricao-box button.enviar:hover {
            background-color: #218838;
        }
        .descricao-box button.cancelar {
            background-color: #dc3545;
        }
        .descricao-box button.cancelar:hover {
            background-color: #c82333;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .popup input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .popup textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .popup .popup-buttons {
            display: flex;
            justify-content: space-between;
        }
        .popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .popup button.enviar {
            background-color: #28a745;
        }
        .popup button.enviar:hover {
            background-color: #218838;
        }
        .popup button.responder {
            background-color: #17a2b8;
        }
        .popup button.responder:hover {
            background-color: #138496;
        }
        .popup button.sair {
            background-color: #dc3545;
        }
        .popup button.sair:hover {
            background-color: #c82333;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        td button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        td button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Solicita√ß√µes de Loja</h1>
        <div class="nav-buttons">
            <span class="notification" onclick="toggleNotifications()">üîî<span class="badge" id="notification-badge">0</span></span>
            <a href="#" class="sair">Sair</a>
            <a href="#" class="home">Home</a>
        </div>
    </div>

    <div class="filters">
        <label for="filial">Filial:</label>
        <select id="filial" name="filial">
            <option value="">Selecione a Filial</option>
            <option value="1">1 | PONTA NEGRA</option>
            <option value="2">2 | ALECRIM</option>
            <option value="7">7 | SAC - CENTRO VI</option>
            <option value="100">100 | LAGOA NOVA</option>
            <option value="121">121 | NORTE SHOPPING</option>
            <option value="122">122 | PARNAMIRIM</option>
            <option value="137">137 | MACAIBA</option>
            <option value="131">131 | ZN2</option>
            <option value="140">140 | MARIA LACERDA</option>
            <option value="141">141 | IGAPO</option>
        </select>

        <label for="tipo_solicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipo_solicitacao" name="tipo_solicitacao">
            <option value="">Selecione o Tipo</option>
            <option value="aguas">√Åguas</option>
            <option value="panfletos">Panfletos Promocionais</option>
            <option value="ajustes">Ajustes de Pedidos</option>
            <option value="outros">Outros</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1">

        <label for="descricao">Descri√ß√£o:</label>
        <input type="text" id="descricao" name="descricao" class="descricao" placeholder="Clique para detalhar" onclick="toggleDescricaoBox()">

        <button onclick="window.print()">Imprimir</button>
        <button onclick="exportarExcel()">Abrir em Excel</button>
    </div>

    <div class="descricao-box" id="descricao-box">
        <input type="text" id="descricao-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="descricao-textarea" placeholder="Digite sua solicita√ß√£o..."></textarea>
        <div class="box-buttons">
            <button class="enviar" onclick="enviarDescricao()">Enviar</button>
            <button class="cancelar" onclick="toggleDescricaoBox()">Cancelar</button>
        </div>
    </div>

    <div class="content">
        <p>Solicita√ß√µes pendentes para o dep√≥sito:</p>
        <table>
            <thead>
                <tr>
                    <th>N√∫mero da Solicita√ß√£o</th>
                    <th>Filial</th>
                    <th>Tipo de Solicita√ß√£o</th>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Data/Hora</th>
                    <th>Matr√≠cula</th>
                    <th>Nome do Usu√°rio</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-solicitacoes">
                -- Solicita√ß√µes ser√£o adicionadas dinamicamente via JavaScript --
            </tbody>
        </table>
    </div>

    <div class="notification-panel" id="notification-panel"></div>
    <div class="overlay" id="overlay" onclick="fecharPopup()"></div>
    <div class="popup" id="popup">
        <input type="text" id="popup-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="popup-textarea" placeholder="Digite sua solicita√ß√£o ou resposta..."></textarea>
        <div class="popup-buttons">
            <button class="enviar" onclick="enviarPopup()">Enviar</button>
            <button class="responder" onclick="responderPopup()">Responder</button>
            <button class="sair" onclick="fecharPopup()">Sair</button>
        </div>
    </div>

    <script>
        let currentRow = null;
        let notificationCount = 0;
        let solicitacoes = []; // Armazenar as solicita√ß√µes com suas descri√ß√µes

        function updateNotificationCount() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let count = tabela.rows.length; // Uma notifica√ß√£o por solicita√ß√£o criada

            for (let row of tabela.rows) {
                const status = row.cells[8].innerText;
                const index = row.rowIndex;
                const solicitacao = solicitacoes[index];
                if (solicitacao && solicitacao.descricao.includes('Resposta:')) {
                    const respostas = (solicitacao.descricao.match(/Resposta:/g) || []).length;
                    count += respostas; // Incrementa para cada resposta
                }
                if (status !== 'Pendente') {
                    count++; // Incrementa para cada mudan√ßa de status
                }
            }

            notificationCount = count;
            document.getElementById('notification-badge').innerText = notificationCount;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const tabela = document.getElementById('tabela-solicitacoes');
            panel.innerHTML = '';

            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                return;
            }

            for (let row of tabela.rows) {
                const numero = row.cells[0].innerText;
                const status = row.cells[8].innerText;
                const index = row.rowIndex;
                const solicitacao = solicitacoes[index];
                let notificacao = `<div class="notification-item">Solicita√ß√£o #${numero}<br>Solicita√ß√£o enviada</div>`;

                if (solicitacao && solicitacao.descricao.includes('Resposta:')) {
                    const respostas = solicitacao.descricao.match(/Resposta: (.*?)( - \d{2}:\d{2}:\d{2})/g) || [];
                    for (let resposta of respostas) {
                        const textoResposta = resposta.match(/Resposta: (.*?)( - \d{2}:\d{2}:\d{2})/)[1];
                        notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Resposta recebida: ${textoResposta}</div>`;
                    }
                }

                if (status !== 'Pendente') {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Status alterado para ${status}</div>`;
                }

                panel.innerHTML += notificacao;
            }

            panel.classList.add('show');
        }

        function toggleDescricaoBox() {
            const box = document.getElementById('descricao-box');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if (box.style.display === 'block') {
                document.getElementById('descricao-titulo').value = '';
                document.getElementById('descricao-textarea').value = '';
            }
        }

        function enviarDescricao() {
            const titulo = document.getElementById('descricao-titulo').value.trim();
            const descricao = document.getElementById('descricao-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por Favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }
            document.getElementById('descricao').value = titulo;
            adicionarSolicitacao(titulo, descricao);
            toggleDescricaoBox();
        }

        function abrirPopup(action, row = null) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'block';
            overlay.style.display = 'block';

            if (row) {
                const index = row.rowIndex;
                const solicitacao = solicitacoes[index];
                if (solicitacao) {
                    document.getElementById('popup-titulo').value = solicitacao.titulo;
                    document.getElementById('popup-textarea').value = solicitacao.descricao;
                } else {
                    document.getElementById('popup-titulo').value = '';
                    document.getElementById('popup-textarea').value = '';
                }
            } else {
                document.getElementById('popup-titulo').value = '';
                document.getElementById('popup-textarea').value = '';
            }

            if (action === 'novo') {
                currentRow = null;
            } else if (action === 'ver') {
                currentRow = row;
            }
        }

        function fecharPopup() {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('popup-titulo').value = '';
            document.getElementById('popup-textarea').value = '';
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.getElementById('popup').style.display === 'block') {
                fecharPopup();
            }
        });

        function enviarPopup() {
            const titulo = document.getElementById('popup-titulo').value.trim();
            const descricao = document.getElementById('popup-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }
            if (currentRow) {
                const index = currentRow.rowIndex;
                solicitacoes[index] = { titulo, descricao };
            }
            fecharPopup();
        }

        function responderPopup() {
            const resposta = prompt('Digite sua resposta:');
            if (resposta) {
                if (currentRow) {
                    const index = currentRow.rowIndex;
                    const solicitacao = solicitacoes[index];
                    solicitacao.descricao += `\nResposta: ${resposta} - ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}`;
                    solicitacoes[index] = solicitacao;
                    updateNotificationCount();
                } else {
                    alert('Selecione uma solicita√ß√£o para responder.');
                }
                fecharPopup();
            }
        }

        function adicionarSolicitacao(titulo, descricao) {
            const filial = document.getElementById('filial').value;
            const tipoSolicitacao = document.getElementById('tipo_solicitacao').value;
            const quantidade = document.getElementById('quantidade').value;

            if (!filial || !tipoSolicitacao || !quantidade || !titulo) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            const filialNome = document.querySelector(`#filial option[value="${filial}"]`).text;
            const dataHora = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            const matricula = '12345';
            const nomeUsuario = 'Usu√°rio Exemplo';
            const numeroSolicitacao = Math.floor(Math.random() * 1000000);
            const status = 'Pendente';

            const tabela = document.getElementById('tabela-solicitacoes');
            const novaLinha = tabela.insertRow();
            novaLinha.innerHTML = `
                <td>${numeroSolicitacao}</td>
                <td>${filialNome}</td>
                <td>${tipoSolicitacao}</td>
                <td><button onclick="abrirPopup('ver', this.parentNode.parentNode)">Ver Obs</button></td>
                <td>${quantidade}</td>
                <td>${dataHora}</td>
                <td>${matricula}</td>
                <td>${nomeUsuario}</td>
                <td>${status}</td>
            `;

            solicitacoes[novaLinha.rowIndex] = { titulo, descricao };

            document.getElementById('filial').value = '';
            document.getElementById('tipo_solicitacao').value = '';
            document.getElementById('quantidade').value = '';
            document.getElementById('descricao').value = '';

            updateNotificationCount();
        }

        function exportarExcel() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let csv = 'N√∫mero da Solicita√ß√£o,Filial,Tipo de Solicita√ß√£o,Descri√ß√£o,Quantidade,Data/Hora,Matr√≠cula,Nome do Usu√°rio,Status\n';
            for (let row of tabela.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText.replace(/,/g, ';'));
                }
                csv += rowData.join(',') + '\n';
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solicitacoes.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

 -->





<!-- 


 <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√µes de Loja</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        .header .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header a {
            text-decoration: none;
            color: white;
            padding: 8px 15px;
            border-radius: 3px;
            font-weight: bold;
        }
        .header a.sair {
            background-color: #e74c3c;
        }
        .header a.sair:hover {
            background-color: #c0392b;
        }
        .header a.home {
            background-color: #2ecc71;
        }
        .header a.home:hover {
            background-color: #27ae60;
        }
        .header .notification {
            position: relative;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .header .notification .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .notification-panel {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .filters {
            background-color: white;
            padding: 15px;
            margin: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filters label {
            font-weight: bold;
            color: #333;
        }
        .filters select, .filters input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 150px;
        }
        .filters input[type="number"] {
            width: 80px;
        }
        .filters input[type="text"].descricao {
            width: 200px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            background-color: #007bff;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .content {
            margin: 20px;
        }
        .content p {
            margin: 0 0 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #333;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .descricao-box {
            display: none;
            margin: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .descricao-box input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .descricao-box textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .descricao-box .box-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .descricao-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .descricao-box button.enviar {
            background-color: #28a745;
        }
        .descricao-box button.enviar:hover {
            background-color: #218838;
        }
        .descricao-box button.cancelar {
            background-color: #dc3545;
        }
        .descricao-box button.cancelar:hover {
            background-color: #c82333;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .popup input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .popup textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .popup .popup-buttons {
            display: flex;
            justify-content: space-between;
        }
        .popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .popup button.enviar {
            background-color: #28a745;
        }
        .popup button.enviar:hover {
            background-color: #218838;
        }
        .popup button.responder {
            background-color: #17a2b8;
        }
        .popup button.responder:hover {
            background-color: #138496;
        }
        .popup button.sair {
            background-color: #dc3545;
        }
        .popup button.sair:hover {
            background-color: #c82333;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        td button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        td button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Solicita√ß√µes de Loja</h1>
        <div class="nav-buttons">
            <span class="notification" onclick="toggleNotifications()">üîî<span class="badge" id="notification-badge">0</span></span>
            <a href="#" class="sair">Sair</a>
            <a href="#" class="home">Home</a>
        </div>
    </div>

    <div class="filters">
        <label for="filial">Filial:</label>
        <select id="filial" name="filial" onchange="aplicarFiltro()">
            <option value="">Selecione a Filial</option>
            <option value="1" {% if filial == '1' %}selected{% endif %}>1 | PONTA NEGRA</option>
            <option value="2" {% if filial == '2' %}selected{% endif %}>2 | ALECRIM</option>
            <option value="7" {% if filial == '7' %}selected{% endif %}>7 | SAC - CENTRO VI</option>
            <option value="100" {% if filial == '100' %}selected{% endif %}>100 | LAGOA NOVA</option>
            <option value="121" {% if filial == '121' %}selected{% endif %}>121 | NORTE SHOPPING</option>
            <option value="122" {% if filial == '122' %}selected{% endif %}>122 | PARNAMIRIM</option>
            <option value="137" {% if filial == '137' %}selected{% endif %}>137 | MACAIBA</option>
            <option value="131" {% if filial == '131' %}selected{% endif %}>131 | ZN2</option>
            <option value="140" {% if filial == '140' %}selected{% endif %}>140 | MARIA LACERDA</option>
            <option value="141" {% if filial == '141' %}selected{% endif %}>141 | IGAPO</option>
        </select>

        <label for="tipo_solicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipo_solicitacao" name="tipo_solicitacao">
            <option value="">Selecione o Tipo</option>
            <option value="aguas">√Åguas</option>
            <option value="panfletos">Panfletos Promocionais</option>
            <option value="ajustes">Ajustes de Pedidos</option>
            <option value="outros">Outros</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1">

        <label for="descricao">Descri√ß√£o:</label>
        <input type="text" id="descricao" name="descricao" class="descricao" placeholder="Clique para detalhar" onclick="toggleDescricaoBox()">

        <button onclick="window.print()">Imprimir</button>
        <button onclick="exportarExcel()">Abrir em Excel</button>
    </div>

    <div class="descricao-box" id="descricao-box">
        <input type="text" id="descricao-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="descricao-textarea" placeholder="Digite sua solicita√ß√£o..."></textarea>
        <div class="box-buttons">
            <button class="enviar" onclick="enviarDescricao()">Enviar</button>
            <button class="cancelar" onclick="toggleDescricaoBox()">Cancelar</button>
        </div>
    </div>

    <div class="content">
        <p>Solicita√ß√µes pendentes para o dep√≥sito:</p>
        <table>
            <thead>
                <tr>
                    <th>N√∫mero da Solicita√ß√£o</th>
                    <th>Filial</th>
                    <th>Tipo de Solicita√ß√£o</th>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Data/Hora</th>
                    <th>Matr√≠cula</th>
                    <th>Nome do Usu√°rio</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-solicitacoes">
                {% for solicitacao in solicitacoes %}
                    <tr data-id="{{ solicitacao.id }}">
                        <td>{{ solicitacao.numero_solicitacao }}</td>
                        <td>{{ solicitacao.filial_id }} | {{ solicitacao.filial_nome }}</td>
                        <td>{{ solicitacao.tipo_solicitacao }}</td>
                        <td><button onclick="abrirPopup('ver', this.parentNode.parentNode)">Ver Obs</button></td>
                        <td>{{ solicitacao.quantidade }}</td>
                        <td>{{ solicitacao.data_hora.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ solicitacao.matricula or '-' }}</td>
                        <td>{{ solicitacao.nome_usuario or '-' }}</td>
                        <td>{{ solicitacao.status }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not solicitacoes %}
            <div class="no-results">Nenhuma solicita√ß√£o encontrada.</div>
        {% endif %}
    </div>

    <div class="notification-panel" id="notification-panel"></div>
    <div class="overlay" id="overlay" onclick="fecharPopup()"></div>
    <div class="popup" id="popup">
        <input type="text" id="popup-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="popup-textarea" placeholder="Digite sua solicita√ß√£o ou resposta..."></textarea>
        <div class="popup-buttons">
            <button class="enviar" onclick="enviarPopup()">Enviar</button>
            <button class="responder" onclick="responderPopup()">Responder</button>
            <button class="sair" onclick="fecharPopup()">Sair</button>
        </div>
    </div>

    <script>
        let currentRow = null;
        let solicitacoes = {{ solicitacoes|tojson }};

        function aplicarFiltro() {
            const filial = document.getElementById('filial').value;
            window.location.href = `/solicitacoes_loja?filial=${filial}`;
        }

        function updateNotificationCount() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let count = tabela.rows.length;

            for (let row of tabela.rows) {
                const status = row.cells[8].innerText;
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (solicitacao && solicitacao.descricao && solicitacao.descricao.includes('Resposta:')) {
                    const respostas = (solicitacao.descricao.match(/Resposta:/g) || []).length;
                    count += respostas;
                }
                if (status !== 'Pendente') {
                    count++;
                }
            }

            document.getElementById('notification-badge').innerText = count;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const tabela = document.getElementById('tabela-solicitacoes');
            panel.innerHTML = '';

            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                return;
            }

            for (let row of tabela.rows) {
                const numero = row.cells[0].innerText;
                const status = row.cells[8].innerText;
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                let notificacao = `<div class="notification-item">Solicita√ß√£o #${numero}<br>Solicita√ß√£o enviada</div>`;

                if (solicitacao && solicitacao.descricao && solicitacao.descricao.includes('Resposta:')) {
                    const respostas = solicitacao.descricao.match(/Resposta: (.*?)( - \d{2}:\d{2}:\d{2})/g) || [];
                    for (let resposta of respostas) {
                        const textoResposta = resposta.match(/Resposta: (.*?)( - \d{2}:\d{2}:\d{2})/)[1];
                        notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Resposta recebida: ${textoResposta}</div>`;
                    }
                }

                if (status !== 'Pendente') {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Status alterado para ${status}</div>`;
                }

                panel.innerHTML += notificacao;
            }

            panel.classList.add('show');
        }

        function toggleDescricaoBox() {
            const box = document.getElementById('descricao-box');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if (box.style.display === 'block') {
                document.getElementById('descricao-titulo').value = '';
                document.getElementById('descricao-textarea').value = '';
            }
        }

        async function enviarDescricao() {
            const titulo = document.getElementById('descricao-titulo').value.trim();
            const descricao = document.getElementById('descricao-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }

            const filial = document.getElementById('filial').value;
            const tipoSolicitacao = document.getElementById('tipo_solicitacao').value;
            const quantidade = document.getElementById('quantidade').value;

            if (!filial || !tipoSolicitacao || !quantidade) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            try {
                const response = await fetch('/criar_solicitacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filial_id: filial,
                        tipo_solicitacao: tipoSolicitacao,
                        quantidade: quantidade,
                        titulo: titulo,
                        descricao: descricao
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Solicita√ß√£o enviada com sucesso!');
                    document.getElementById('filial').value = '';
                    document.getElementById('tipo_solicitacao').value = '';
                    document.getElementById('quantidade').value = '';
                    document.getElementById('descricao').value = '';
                    toggleDescricaoBox();
                    window.location.reload();
                } else {
                    alert('Erro ao enviar solicita√ß√£o: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao enviar solicita√ß√£o:', error);
                alert('Erro ao enviar solicita√ß√£o: ' + error.message);
            }
        }

        function abrirPopup(action, row = null) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'block';
            overlay.style.display = 'block';

            if (row) {
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (solicitacao) {
                    document.getElementById('popup-titulo').value = solicitacao.titulo || '';
                    document.getElementById('popup-textarea').value = solicitacao.descricao || '';
                } else {
                    document.getElementById('popup-titulo').value = '';
                    document.getElementById('popup-textarea').value = '';
                }
                currentRow = row;
            } else {
                document.getElementById('popup-titulo').value = '';
                document.getElementById('popup-textarea').value = '';
                currentRow = null;
            }
        }

        function fecharPopup() {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('popup-titulo').value = '';
            document.getElementById('popup-textarea').value = '';
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.getElementById('popup').style.display === 'block') {
                fecharPopup();
            }
        });

        async function enviarPopup() {
            const titulo = document.getElementById('popup-titulo').value.trim();
            const descricao = document.getElementById('popup-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }

            if (currentRow) {
                const index = currentRow.rowIndex - 1;
                const id = solicitacoes[index].id;
                try {
                    const response = await fetch(`/atualizar_solicitacao/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ titulo, descricao })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Solicita√ß√£o atualizada com sucesso!');
                        fecharPopup();
                        window.location.reload();
                    } else {
                        alert('Erro ao atualizar solicita√ß√£o: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar solicita√ß√£o:', error);
                    alert('Erro ao atualizar solicita√ß√£o: ' + error.message);
                }
            } else {
                alert('Selecione uma solicita√ß√£o para atualizar.');
            }
        }

        async function responderPopup() {
            const resposta = document.getElementById('popup-textarea').value.trim();
            if (!resposta) {
                alert('Por favor, digite uma resposta.');
                return;
            }

            if (currentRow) {
                const index = currentRow.rowIndex - 1;
                const id = solicitacoes[index].id;
                try {
                    const response = await fetch(`/responder_solicitacao/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resposta })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Resposta enviada com sucesso!');
                        fecharPopup();
                        window.location.reload();
                    } else {
                        alert('Erro ao enviar resposta: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao enviar resposta:', error);
                    alert('Erro ao enviar resposta: ' + error.message);
                }
            } else {
                alert('Selecione uma solicita√ß√£o para responder.');
            }
        }

        function exportarExcel() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let csv = 'N√∫mero da Solicita√ß√£o,Filial,Tipo de Solicita√ß√£o,Descri√ß√£o,Quantidade,Data/Hora,Matr√≠cula,Nome do Usu√°rio,Status\n';
            for (let row of tabela.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText.replace(/,/g, ';'));
                }
                csv += rowData.join(',') + '\n';
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solicitacoes.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.onload = function() {
            updateNotificationCount();
        };
    </script>
</body>
</html> -->













<!-- 



<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√µes de Loja</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        .header .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header a {
            text-decoration: none;
            color: white;
            padding: 8px 15px;
            border-radius: 3px;
            font-weight: bold;
        }
        .header a.sair {
            background-color: #e74c3c;
        }
        .header a.sair:hover {
            background-color: #c0392b;
        }
        .header a.home {
            background-color: #2ecc71;
        }
        .header a.home:hover {
            background-color: #27ae60;
        }
        .header .notification {
            position: relative;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .header .notification .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .notification-panel {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .filters {
            background-color: white;
            padding: 15px;
            margin: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filters label {
            font-weight: bold;
            color: #333;
        }
        .filters select, .filters input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 150px;
        }
        .filters input[type="number"] {
            width: 80px;
        }
        .filters input[type="text"].descricao {
            width: 200px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            background-color: #007bff;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .content {
            margin: 20px;
        }
        .content p {
            margin: 0 0 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #333;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .descricao-box {
            display: none;
            margin: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .descricao-box input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .descricao-box textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .descricao-box .box-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .descricao-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .descricao-box button.enviar {
            background-color: #28a745;
        }
        .descricao-box button.enviar:hover {
            background-color: #218838;
        }
        .descricao-box button.cancelar {
            background-color: #dc3545;
        }
        .descricao-box button.cancelar:hover {
            background-color: #c82333;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .popup input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .popup textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .popup .popup-buttons {
            display: flex;
            justify-content: space-between;
        }
        .popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .popup button.enviar {
            background-color: #28a745;
        }
        .popup button.enviar:hover {
            background-color: #218838;
        }
        .popup button.responder {
            background-color: #17a2b8;
        }
        .popup button.responder:hover {
            background-color: #138496;
        }
        .popup button.sair {
            background-color: #dc3545;
        }
        .popup button.sair:hover {
            background-color: #c82333;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        td button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        td button:hover {
            background-color: #0056b3;
        }
        .popup .respostas {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 3px;
            max-height: 150px;
            overflow-y: auto;
        }
        .popup .respostas p {
            margin: 5px 0;
            padding: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Solicita√ß√µes de Loja</h1>
        <div class="nav-buttons">
            <span class="notification" onclick="toggleNotifications()">üîî<span class="badge" id="notification-badge">0</span></span>
            <a href="#" class="sair">Sair</a>
            <a href="#" class="home">Home</a>
        </div>
    </div>

    <div class="filters">
        <label for="filial">Filial:</label>
        <select id="filial" name="filial" onchange="aplicarFiltro()">
            <option value="">Selecione a Filial</option>
            <option value="1" {% if filial == '1' %}selected{% endif %}>1 | PONTA NEGRA</option>
            <option value="2" {% if filial == '2' %}selected{% endif %}>2 | ALECRIM</option>
            <option value="7" {% if filial == '7' %}selected{% endif %}>7 | SAC - CENTRO VI</option>
            <option value="100" {% if filial == '100' %}selected{% endif %}>100 | LAGOA NOVA</option>
            <option value="121" {% if filial == '121' %}selected{% endif %}>121 | NORTE SHOPPING</option>
            <option value="122" {% if filial == '122' %}selected{% endif %}>122 | PARNAMIRIM</option>
            <option value="137" {% if filial == '137' %}selected{% endif %}>137 | MACAIBA</option>
            <option value="131" {% if filial == '131' %}selected{% endif %}>131 | ZN2</option>
            <option value="140" {% if filial == '140' %}selected{% endif %}>140 | MARIA LACERDA</option>
            <option value="141" {% if filial == '141' %}selected{% endif %}>141 | IGAPO</option>
        </select>

        <label for="tipo_solicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipo_solicitacao" name="tipo_solicitacao">
            <option value="">Selecione o Tipo</option>
            <option value="aguas">√Åguas</option>
            <option value="panfletos">Panfletos Promocionais</option>
            <option value="ajustes">Ajustes de Pedidos</option>
            <option value="outros">Outros</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1">

        <label for="descricao">Descri√ß√£o:</label>
        <input type="text" id="descricao" name="descricao" class="descricao" placeholder="Clique para detalhar" onclick="toggleDescricaoBox()">

        <button onclick="window.print()">Imprimir</button>
        <button onclick="exportarExcel()">Abrir em Excel</button>
    </div>

    <div class="descricao-box" id="descricao-box">
        <input type="text" id="descricao-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="descricao-textarea" placeholder="Digite sua solicita√ß√£o..."></textarea>
        <div class="box-buttons">
            <button class="enviar" onclick="enviarDescricao()">Enviar</button>
            <button class="cancelar" onclick="toggleDescricaoBox()">Cancelar</button>
        </div>
    </div>

    <div class="content">
        <p>Solicita√ß√µes pendentes para o dep√≥sito:</p>
        {% if erro %}
            <div class="error-message" style="color: red;">{{ erro }}</div>
        {% endif %}
        <table>
            <thead>
                <tr>
                    <th>N√∫mero da Solicita√ß√£o</th>
                    <th>Filial</th>
                    <th>Tipo de Solicita√ß√£o</th>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Data/Hora</th>
                    <th>Matr√≠cula</th>
                    <th>Nome do Usu√°rio</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-solicitacoes">
                {% if solicitacoes %}
                    {% for solicitacao in solicitacoes %}
                        <tr data-id="{{ solicitacao.id }}">
                            <td>{{ solicitacao.numero_solicitacao }}</td>
                            <td>{{ solicitacao.filial_id }} | {{ solicitacao.filial_nome }}</td>
                            <td>{{ solicitacao.tipo_solicitacao | default('Sem tipo') }}</td>
                            <td><button onclick="abrirPopup('ver', this.parentNode.parentNode)">Ver Obs</button></td>
                            <td>{{ solicitacao.quantidade | default('0') }}</td>
                            <td>{{ solicitacao.data_hora.strftime('%d/%m/%Y %H:%M') if solicitacao.data_hora else 'Sem data' }}</td>
                            <td>{{ solicitacao.matricula | default('-') }}</td>
                            <td>{{ solicitacao.nome_usuario | default('-') }}</td>
                            <td>{{ solicitacao.status | default('Pendente') }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" style="text-align: center;">Nenhuma solicita√ß√£o encontrada.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="notification-panel" id="notification-panel"></div>
    <div class="overlay" id="overlay" onclick="fecharPopup()"></div>
    <div class="popup" id="popup">
        <input type="text" id="popup-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="popup-textarea" placeholder="Digite sua solicita√ß√£o ou resposta..."></textarea>
        <div class="respostas" id="respostas-list"></div>
        <div class="popup-buttons">
            <button class="enviar" onclick="enviarPopup()">Enviar</button>
            <button class="responder" onclick="responderPopup()">Responder</button>
            <button class="sair" onclick="fecharPopup()">Sair</button>
        </div>
    </div>

    <script>
        let currentRow = null;
        let solicitacoes = {{ solicitacoes|tojson|safe }};
        let respostas = {{ respostas|tojson|safe }};

        function aplicarFiltro() {
            const filial = document.getElementById('filial').value;
            window.location.href = `/solicitacoes_loja?filial=${filial}`;
        }

        function updateNotificationCount() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let count = tabela.rows.length;

            for (let row of tabela.rows) {
                const status = row.cells[8].innerText;
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (!solicitacao) continue; // Evitar erros se solicitacao n√£o estiver definida
                const numeroSolicitacao = solicitacao.numero_solicitacao;
                const respostasAssociadas = respostas.filter(r => r.numero_solicitacao === numeroSolicitacao);
                count += respostasAssociadas.length;
                if (status !== 'Pendente') {
                    count++;
                }
            }

            document.getElementById('notification-badge').innerText = count;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const tabela = document.getElementById('tabela-solicitacoes');
            panel.innerHTML = '';

            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                return;
            }

            for (let row of tabela.rows) {
                const numero = row.cells[0].innerText;
                const status = row.cells[8].innerText;
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (!solicitacao) continue; // Evitar erros se solicitacao n√£o estiver definida
                let notificacao = `<div class="notification-item">Solicita√ß√£o #${numero}<br>Solicita√ß√£o enviada</div>`;

                const respostasAssociadas = respostas.filter(r => r.numero_solicitacao === numero);
                for (let resposta of respostasAssociadas) {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Resposta recebida: ${resposta.resposta} (${resposta.data_hora})</div>`;
                }

                if (status !== 'Pendente') {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Status alterado para ${status}</div>`;
                }

                panel.innerHTML += notificacao;
            }

            panel.classList.add('show');
        }

        function toggleDescricaoBox() {
            const box = document.getElementById('descricao-box');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if (box.style.display === 'block') {
                document.getElementById('descricao-titulo').value = '';
                document.getElementById('descricao-textarea').value = '';
            }
        }

        async function enviarDescricao() {
            const titulo = document.getElementById('descricao-titulo').value.trim();
            const descricao = document.getElementById('descricao-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }

            const filial = document.getElementById('filial').value;
            const tipoSolicitacao = document.getElementById('tipo_solicitacao').value;
            const quantidade = document.getElementById('quantidade').value;

            if (!filial || !tipoSolicitacao || !quantidade) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            try {
                const response = await fetch('/criar_solicitacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filial_id: filial,
                        tipo_solicitacao: tipoSolicitacao,
                        quantidade: quantidade,
                        titulo: titulo,
                        descricao: descricao
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Solicita√ß√£o enviada com sucesso!');
                    document.getElementById('filial').value = '';
                    document.getElementById('tipo_solicitacao').value = '';
                    document.getElementById('quantidade').value = '';
                    document.getElementById('descricao').value = '';
                    toggleDescricaoBox();
                    window.location.reload();
                } else {
                    alert('Erro ao enviar solicita√ß√£o: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao enviar solicita√ß√£o:', error);
                alert('Erro ao enviar solicita√ß√£o: ' + error.message);
            }
        }

        function abrirPopup(action, row = null) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            const respostasList = document.getElementById('respostas-list');
            popup.style.display = 'block';
            overlay.style.display = 'block';

            if (row) {
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (solicitacao) {
                    document.getElementById('popup-titulo').value = solicitacao.titulo || '';
                    document.getElementById('popup-textarea').value = '';
                    respostasList.innerHTML = `<p><strong>Descri√ß√£o Inicial:</strong> ${solicitacao.descricao || 'Sem descri√ß√£o'}</p>`;
                    const respostasAssociadas = respostas.filter(r => r.numero_solicitacao === solicitacao.numero_solicitacao);
                    for (let resposta of respostasAssociadas) {
                        respostasList.innerHTML += `<p><strong>Resposta (${resposta.usuario} - ${resposta.data_hora}):</strong> ${resposta.resposta}</p>`;
                    }
                } else {
                    document.getElementById('popup-titulo').value = '';
                    document.getElementById('popup-textarea').value = '';
                    respostasList.innerHTML = '';
                }
                currentRow = row;
            } else {
                document.getElementById('popup-titulo').value = '';
                document.getElementById('popup-textarea').value = '';
                respostasList.innerHTML = '';
                currentRow = null;
            }
        }

        function fecharPopup() {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('popup-titulo').value = '';
            document.getElementById('popup-textarea').value = '';
            document.getElementById('respostas-list').innerHTML = '';
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.getElementById('popup').style.display === 'block') {
                fecharPopup();
            }
        });

        async function enviarPopup() {
            const titulo = document.getElementById('popup-titulo').value.trim();
            const descricao = document.getElementById('popup-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }

            if (currentRow) {
                const index = currentRow.rowIndex - 1;
                const id = solicitacoes[index].id;
                try {
                    const response = await fetch(`/atualizar_solicitacao/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ titulo, descricao })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Solicita√ß√£o atualizada com sucesso!');
                        fecharPopup();
                        window.location.reload();
                    } else {
                        alert('Erro ao atualizar solicita√ß√£o: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar solicita√ß√£o:', error);
                    alert('Erro ao atualizar solicita√ß√£o: ' + error.message);
                }
            } else {
                alert('Selecione uma solicita√ß√£o para atualizar.');
            }
        }

        async function responderPopup() {
            const resposta = document.getElementById('popup-textarea').value.trim();
            if (!resposta) {
                alert('Por favor, digite uma resposta.');
                return;
            }

            if (currentRow) {
                const index = currentRow.rowIndex - 1;
                const id = solicitacoes[index].id;
                try {
                    const response = await fetch(`/responder_solicitacao/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resposta })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Resposta enviada com sucesso!');
                        fecharPopup();
                        window.location.reload();
                    } else {
                        alert('Erro ao enviar resposta: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao enviar resposta:', error);
                    alert('Erro ao enviar resposta: ' + error.message);
                }
            } else {
                alert('Selecione uma solicita√ß√£o para responder.');
            }
        }

        function exportarExcel() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let csv = 'N√∫mero da Solicita√ß√£o,Filial,Tipo de Solicita√ß√£o,Descri√ß√£o,Quantidade,Data/Hora,Matr√≠cula,Nome do Usu√°rio,Status\n';
            for (let row of tabela.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText.replace(/,/g, ';'));
                }
                csv += rowData.join(',') + '\n';
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solicitacoes.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.onload = function() {
            console.log("Solicita√ß√µes recebidas no frontend:", solicitacoes); // Log para depura√ß√£o
            console.log("Respostas recebidas no frontend:", respostas); // Log para depura√ß√£o
            updateNotificationCount();
        };
    </script>
</body>
</html> -->

<!-- 
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√µes de Loja</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        .header .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header a {
            text-decoration: none;
            color: white;
            padding: 8px 15px;
            border-radius: 3px;
            font-weight: bold;
        }
        .header a.sair {
            background-color: #e74c3c;
        }
        .header a.sair:hover {
            background-color: #c0392b;
        }
        .header a.home {
            background-color: #2ecc71;
        }
        .header a.home:hover {
            background-color: #27ae60;
        }
        .header .notification {
            position: relative;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .header .notification .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .notification-panel {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .filters {
            background-color: white;
            padding: 15px;
            margin: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filters label {
            font-weight: bold;
            color: #333;
        }
        .filters select, .filters input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 150px;
        }
        .filters input[type="number"] {
            width: 80px;
        }
        .filters input[type="text"].descricao {
            width: 200px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            background-color: #007bff;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .content {
            margin: 20px;
        }
        .content p {
            margin: 0 0 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #333;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .descricao-box {
            display: none;
            margin: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .descricao-box input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .descricao-box textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .descricao-box .box-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .descricao-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .descricao-box button.enviar {
            background-color: #28a745;
        }
        .descricao-box button.enviar:hover {
            background-color: #218838;
        }
        .descricao-box button.cancelar {
            background-color: #dc3545;
        }
        .descricao-box button.cancelar:hover {
            background-color: #c82333;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .popup input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .popup textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .popup .popup-buttons {
            display: flex;
            justify-content: space-between;
        }
        .popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .popup button.enviar {
            background-color: #28a745;
        }
        .popup button.enviar:hover {
            background-color: #218838;
        }
        .popup button.responder {
            background-color: #17a2b8;
        }
        .popup button.responder:hover {
            background-color: #138496;
        }
        .popup button.sair {
            background-color: #dc3545;
        }
        .popup button.sair:hover {
            background-color: #c82333;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        td button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        td button:hover {
            background-color: #0056b3;
        }
        .popup .respostas {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 3px;
            max-height: 150px;
            overflow-y: auto;
        }
        .popup .respostas p {
            margin: 5px 0;
            padding: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Solicita√ß√µes de Loja</h1>
        <div class="nav-buttons">
            <span class="notification" onclick="toggleNotifications()">üîî<span class="badge" id="notification-badge">0</span></span>
            <a href="#" class="sair">Sair</a>
            <a href="#" class="home">Home</a>
        </div>
    </div>

    <div class="filters">
        <label for="filial">Filial:</label>
        <select id="filial" name="filial" onchange="aplicarFiltro()">
            <option value="">Selecione a Filial</option>
            <option value="1" {% if filial == '1' %}selected{% endif %}>1 | PONTA NEGRA</option>
            <option value="2" {% if filial == '2' %}selected{% endif %}>2 | ALECRIM</option>
            <option value="7" {% if filial == '7' %}selected{% endif %}>7 | SAC - CENTRO VI</option>
            <option value="100" {% if filial == '100' %}selected{% endif %}>100 | LAGOA NOVA</option>
            <option value="121" {% if filial == '121' %}selected{% endif %}>121 | NORTE SHOPPING</option>
            <option value="122" {% if filial == '122' %}selected{% endif %}>122 | PARNAMIRIM</option>
            <option value="137" {% if filial == '137' %}selected{% endif %}>137 | MACAIBA</option>
            <option value="131" {% if filial == '131' %}selected{% endif %}>131 | ZN2</option>
            <option value="140" {% if filial == '140' %}selected{% endif %}>140 | MARIA LACERDA</option>
            <option value="141" {% if filial == '141' %}selected{% endif %}>141 | IGAPO</option>
        </select>

        <label for="tipo_solicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipo_solicitacao" name="tipo_solicitacao">
            <option value="">Selecione o Tipo</option>
            <option value="aguas">√Åguas</option>
            <option value="panfletos">Panfletos Promocionais</option>
            <option value="ajustes">Ajustes de Pedidos</option>
            <option value="outros">Outros</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1">

        <label for="descricao">Descri√ß√£o:</label>
        <input type="text" id="descricao" name="descricao" class="descricao" placeholder="Clique para detalhar" onclick="toggleDescricaoBox()">

        <button onclick="window.print()">Imprimir</button>
        <button onclick="exportarExcel()">Abrir em Excel</button>
    </div>

    <div class="descricao-box" id="descricao-box">
        <input type="text" id="descricao-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="descricao-textarea" placeholder="Digite sua solicita√ß√£o..."></textarea>
        <div class="box-buttons">
            <button class="enviar" onclick="enviarDescricao()">Enviar</button>
            <button class="cancelar" onclick="toggleDescricaoBox()">Cancelar</button>
        </div>
    </div>

    <div class="content">
        <p>Solicita√ß√µes pendentes para o dep√≥sito:</p>
        {% if erro %}
            <div class="error-message" style="color: red;">{{ erro }}</div>
        {% endif %}
        <table>
            <thead>
                <tr>
                    <th>N√∫mero da Solicita√ß√£o</th>
                    <th>Filial</th>
                    <th>Tipo de Solicita√ß√£o</th>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Data/Hora</th>
                    <th>Matr√≠cula</th>
                    <th>Nome do Usu√°rio</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-solicitacoes">
                {% if solicitacoes %}
                    {% for solicitacao in solicitacoes %}
                        <tr data-id="{{ solicitacao.id | default('N/A') }}">
                            <td>{{ solicitacao.numero_solicitacao | default('N/A') }}</td>
                            <td>{{ solicitacao.filial_id | default('N/A') }} | {{ solicitacao.filial_nome | default('N/A') }}</td>
                            <td>{{ solicitacao.tipo_solicitacao | default('Sem tipo') }}</td>
                            <td><button onclick="abrirPopup('ver', this.parentNode.parentNode)">Ver Obs</button></td>
                            <td>{{ solicitacao.quantidade | default('0') }}</td>
                            <td>{{ solicitacao.data_hora.strftime('%d/%m/%Y %H:%M') if solicitacao.data_hora else 'Sem data' }}</td>
                            <td>{{ solicitacao.matricula | default('-') }}</td>
                            <td>{{ solicitacao.nome_usuario | default('-') }}</td>
                            <td>{{ solicitacao.status | default('Pendente') }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" style="text-align: center;">Nenhuma solicita√ß√£o encontrada.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="notification-panel" id="notification-panel"></div>
    <div class="overlay" id="overlay" onclick="fecharPopup()"></div>
    <div class="popup" id="popup">
        <input type="text" id="popup-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="popup-textarea" placeholder="Digite sua solicita√ß√£o ou resposta..."></textarea>
        <div class="respostas" id="respostas-list"></div>
        <div class="popup-buttons">
            <button class="enviar" onclick="enviarPopup()">Enviar</button>
            <button class="responder" onclick="responderPopup()">Responder</button>
            <button class="sair" onclick="fecharPopup()">Sair</button>
        </div>
    </div>

    <script>
        let currentRow = null;
        let solicitacoes = {{ solicitacoes|tojson|safe }};
        let respostas = {{ respostas|tojson|safe }};

        console.log("Solicita√ß√µes recebidas no frontend:", solicitacoes);
        console.log("Respostas recebidas no frontend:", respostas);

        function aplicarFiltro() {
            const filial = document.getElementById('filial').value;
            window.location.href = `/solicitacoes_loja?filial=${filial}`;
        }

        function updateNotificationCount() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let count = tabela.rows.length;

            for (let row of tabela.rows) {
                const status = row.cells[8].innerText;
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (!solicitacao) continue;
                const numeroSolicitacao = solicitacao.numero_solicitacao;
                const respostasAssociadas = respostas.filter(r => r.numero_solicitacao === numeroSolicitacao);
                count += respostasAssociadas.length;
                if (status !== 'Pendente') {
                    count++;
                }
            }

            document.getElementById('notification-badge').innerText = count;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const tabela = document.getElementById('tabela-solicitacoes');
            panel.innerHTML = '';

            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
                return;
            }

            for (let row of tabela.rows) {
                const numero = row.cells[0].innerText;
                const status = row.cells[8].innerText;
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (!solicitacao) continue;
                let notificacao = `<div class="notification-item">Solicita√ß√£o #${numero}<br>Solicita√ß√£o enviada</div>`;

                const respostasAssociadas = respostas.filter(r => r.numero_solicitacao === numero);
                for (let resposta of respostasAssociadas) {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Resposta recebida: ${resposta.resposta} (${resposta.data_hora})</div>`;
                }

                if (status !== 'Pendente') {
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Status alterado para ${status}</div>`;
                }

                panel.innerHTML += notificacao;
            }

            panel.classList.add('show');
        }

        function toggleDescricaoBox() {
            const box = document.getElementById('descricao-box');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if (box.style.display === 'block') {
                document.getElementById('descricao-titulo').value = '';
                document.getElementById('descricao-textarea').value = '';
            }
        }

        async function enviarDescricao() {
            const titulo = document.getElementById('descricao-titulo').value.trim();
            const descricao = document.getElementById('descricao-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }

            const filial = document.getElementById('filial').value;
            const tipoSolicitacao = document.getElementById('tipo_solicitacao').value;
            const quantidade = document.getElementById('quantidade').value;

            if (!filial || !tipoSolicitacao || !quantidade) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            try {
                const response = await fetch('/criar_solicitacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filial_id: filial,
                        tipo_solicitacao: tipoSolicitacao,
                        quantidade: quantidade,
                        titulo: titulo,
                        descricao: descricao
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Solicita√ß√£o enviada com sucesso!');
                    document.getElementById('filial').value = '';
                    document.getElementById('tipo_solicitacao').value = '';
                    document.getElementById('quantidade').value = '';
                    document.getElementById('descricao').value = '';
                    toggleDescricaoBox();
                    window.location.reload();
                } else {
                    alert('Erro ao enviar solicita√ß√£o: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao enviar solicita√ß√£o:', error);
                alert('Erro ao enviar solicita√ß√£o: ' + error.message);
            }
        }

        function abrirPopup(action, row = null) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            const respostasList = document.getElementById('respostas-list');
            popup.style.display = 'block';
            overlay.style.display = 'block';

            if (row) {
                const index = row.rowIndex - 1;
                const solicitacao = solicitacoes[index];
                if (solicitacao) {
                    document.getElementById('popup-titulo').value = solicitacao.titulo || '';
                    document.getElementById('popup-textarea').value = '';
                    respostasList.innerHTML = `<p><strong>Descri√ß√£o Inicial:</strong> ${solicitacao.descricao || 'Sem descri√ß√£o'}</p>`;
                    const respostasAssociadas = respostas.filter(r => r.numero_solicitacao === solicitacao.numero_solicitacao);
                    for (let resposta of respostasAssociadas) {
                        respostasList.innerHTML += `<p><strong>Resposta (${resposta.usuario} - ${resposta.data_hora}):</strong> ${resposta.resposta}</p>`;
                    }
                } else {
                    document.getElementById('popup-titulo').value = '';
                    document.getElementById('popup-textarea').value = '';
                    respostasList.innerHTML = '';
                }
                currentRow = row;
            } else {
                document.getElementById('popup-titulo').value = '';
                document.getElementById('popup-textarea').value = '';
                respostasList.innerHTML = '';
                currentRow = null;
            }
        }

        function fecharPopup() {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            popup.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('popup-titulo').value = '';
            document.getElementById('popup-textarea').value = '';
            document.getElementById('respostas-list').innerHTML = '';
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && document.getElementById('popup').style.display === 'block') {
                fecharPopup();
            }
        });

        async function enviarPopup() {
            const titulo = document.getElementById('popup-titulo').value.trim();
            const descricao = document.getElementById('popup-textarea').value.trim();
            if (!titulo || !descricao) {
                alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
                return;
            }

            if (currentRow) {
                const index = currentRow.rowIndex - 1;
                const id = solicitacoes[index].id;
                try {
                    const response = await fetch(`/atualizar_solicitacao/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ titulo, descricao })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Solicita√ß√£o atualizada com sucesso!');
                        fecharPopup();
                        window.location.reload();
                    } else {
                        alert('Erro ao atualizar solicita√ß√£o: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar solicita√ß√£o:', error);
                    alert('Erro ao atualizar solicita√ß√£o: ' + error.message);
                }
            } else {
                alert('Selecione uma solicita√ß√£o para atualizar.');
            }
        }

        async function responderPopup() {
            const resposta = document.getElementById('popup-textarea').value.trim();
            if (!resposta) {
                alert('Por favor, digite uma resposta.');
                return;
            }

            if (currentRow) {
                const index = currentRow.rowIndex - 1;
                const id = solicitacoes[index].id;
                try {
                    const response = await fetch(`/responder_solicitacao/${id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resposta })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Resposta enviada com sucesso!');
                        fecharPopup();
                        window.location.reload();
                    } else {
                        alert('Erro ao enviar resposta: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro ao enviar resposta:', error);
                    alert('Erro ao enviar resposta: ' + error.message);
                }
            } else {
                alert('Selecione uma solicita√ß√£o para responder.');
            }
        }

        function exportarExcel() {
            const tabela = document.getElementById('tabela-solicitacoes');
            let csv = 'N√∫mero da Solicita√ß√£o,Filial,Tipo de Solicita√ß√£o,Descri√ß√£o,Quantidade,Data/Hora,Matr√≠cula,Nome do Usu√°rio,Status\n';
            for (let row of tabela.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText.replace(/,/g, ';'));
                }
                csv += rowData.join(',') + '\n';
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solicitacoes.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        window.onload = function() {
            updateNotificationCount();
        };
    </script>
</body>
</html> -->



<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicita√ß√µes de Loja</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .header {
            background-color: #34495e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 20px;
        }
        .header .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header a {
            text-decoration: none;
            color: white;
            padding: 8px 15px;
            border-radius: 3px;
            font-weight: bold;
        }
        .header a.sair {
            background-color: #e74c3c;
        }
        .header a.sair:hover {
            background-color: #c0392b;
        }
        .header a.home {
            background-color: #2ecc71;
        }
        .header a.home:hover {
            background-color: #27ae60;
        }
        .header .notification {
            position: relative;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .header .notification .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .notification-panel {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .filters {
            background-color: white;
            padding: 15px;
            margin: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filters label {
            font-weight: bold;
            color: #333;
        }
        .filters select, .filters input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 150px;
        }
        .filters input[type="number"] {
            width: 80px;
        }
        .filters input[type="text"].descricao {
            width: 200px;
        }
        .filters button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            background-color: #007bff;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .content {
            margin: 20px;
        }
        .content p {
            margin: 0 0 10px 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            color: #333;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .descricao-box {
            display: none;
            margin: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .descricao-box input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .descricao-box textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .descricao-box .box-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .descricao-box button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .descricao-box button.enviar {
            background-color: #28a745;
        }
        .descricao-box button.enviar:hover {
            background-color: #218838;
        }
        .descricao-box button.cancelar {
            background-color: #dc3545;
        }
        .descricao-box button.cancelar:hover {
            background-color: #c82333;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 400px;
        }
        .popup input[type="text"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .popup textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .popup .popup-buttons {
            display: flex;
            justify-content: space-between;
        }
        .popup button {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        .popup button.enviar {
            background-color: #28a745;
        }
        .popup button.enviar:hover {
            background-color: #218838;
        }
        .popup button.responder {
            background-color: #17a2b8;
        }
        .popup button.responder:hover {
            background-color: #138496;
        }
        .popup button.sair {
            background-color: #dc3545;
        }
        .popup button.sair:hover {
            background-color: #c82333;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        td button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        td button:hover {
            background-color: #0056b3;
        }
        .popup .respostas {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 3px;
            max-height: 150px;
            overflow-y: auto;
        }
        .popup .respostas p {
            margin: 5px 0;
            padding: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Solicita√ß√µes de Loja</h1>
        <div class="nav-buttons">
            <span class="notification" onclick="toggleNotifications()">üîî<span class="badge" id="notification-badge">0</span></span>
            <a href="#" class="sair">Sair</a>
            <a href="#" class="home">Home</a>
        </div>
    </div>

    <div class="filters">
        <label for="filial">Filial:</label>
        <select id="filial" name="filial" onchange="aplicarFiltro()">
            <option value="">Selecione a Filial</option>
            <option value="1" {% if filial == '1' %}selected{% endif %}>1 | PONTA NEGRA</option>
            <option value="2" {% if filial == '2' %}selected{% endif %}>2 | ALECRIM</option>
            <option value="7" {% if filial == '7' %}selected{% endif %}>7 | SAC - CENTRO VI</option>
            <option value="100" {% if filial == '100' %}selected{% endif %}>100 | LAGOA NOVA</option>
            <option value="121" {% if filial == '121' %}selected{% endif %}>121 | NORTE SHOPPING</option>
            <option value="122" {% if filial == '122' %}selected{% endif %}>122 | PARNAMIRIM</option>
            <option value="137" {% if filial == '137' %}selected{% endif %}>137 | MACAIBA</option>
            <option value="131" {% if filial == '131' %}selected{% endif %}>131 | ZN2</option>
            <option value="140" {% if filial == '140' %}selected{% endif %}>140 | MARIA LACERDA</option>
            <option value="141" {% if filial == '141' %}selected{% endif %}>141 | IGAPO</option>
        </select>

        <label for="tipo_solicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipo_solicitacao" name="tipo_solicitacao">
            <option value="">Selecione o Tipo</option>
            <option value="aguas">√Åguas</option>
            <option value="panfletos">Panfletos Promocionais</option>
            <option value="ajustes">Ajustes de Pedidos</option>
            <option value="outros">Outros</option>
        </select>

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="1">

        <label for="descricao">Descri√ß√£o:</label>
        <input type="text" id="descricao" name="descricao" class="descricao" placeholder="Clique para detalhar" onclick="toggleDescricaoBox()">

        <button onclick="window.print()">Imprimir</button>
        <button onclick="exportarExcel()">Abrir em Excel</button>
    </div>

    <div class="descricao-box" id="descricao-box">
        <input type="text" id="descricao-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="descricao-textarea" placeholder="Digite sua solicita√ß√£o..."></textarea>
        <div class="box-buttons">
            <button class="enviar" onclick="enviarDescricao()">Enviar</button>
            <button class="cancelar" onclick="toggleDescricaoBox()">Cancelar</button>
        </div>
    </div>

    <div class="content">
        <p>Solicita√ß√µes pendentes para o dep√≥sito:</p>
        {% if erro %}
            <div class="error-message" style="color: red;">{{ erro }}</div>
        {% endif %}
        <table>
            <thead>
                <tr>
                    <th>N√∫mero da Solicita√ß√£o</th>
                    <th>Filial</th>
                    <th>Tipo de Solicita√ß√£o</th>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Data/Hora</th>
                    <th>Matr√≠cula</th>
                    <th>Nome do Usu√°rio</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tabela-solicitacoes">
                {% if solicitacoes %}
                    {% for solicitacao in solicitacoes %}
                        <tr data-id="{{ solicitacao.id | default('N/A') }}">
                            <td>{{ solicitacao.numero_solicitacao | default('N/A') }}</td>
                            <td>{{ solicitacao.filial_id | default('N/A') }} | {{ solicitacao.filial_nome | default('N/A') }}</td>
                            <td>{{ solicitacao.tipo_solicitacao | default('Sem tipo') }}</td>
                            <td><button onclick="abrirPopup('ver', this.parentNode.parentNode)">Ver Obs</button></td>
                            <td>{{ solicitacao.quantidade | default('0') }}</td>
                            <td>{{ solicitacao.data_hora.strftime('%d/%m/%Y %H:%M') if solicitacao.data_hora else 'Sem data' }}</td>
                            <td>{{ solicitacao.matricula | default('-') }}</td>
                            <td>{{ solicitacao.nome_usuario | default('-') }}</td>
                            <td>{{ solicitacao.status | default('Pendente') }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" style="text-align: center;">Nenhuma solicita√ß√£o encontrada.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="notification-panel" id="notification-panel"></div>
    <div class="overlay" id="overlay" onclick="fecharPopup()"></div>
    <div class="popup" id="popup">
        <input type="text" id="popup-titulo" placeholder="T√≠tulo da Observa√ß√£o" maxlength="50">
        <textarea id="popup-textarea" placeholder="Digite sua solicita√ß√£o ou resposta..."></textarea>
        <div class="respostas" id="respostas-list"></div>
        <div class="popup-buttons">
            <button class="enviar" onclick="enviarPopup()">Enviar</button>
            <button class="responder" onclick="responderPopup()">Responder</button>
            <button class="sair" onclick="fecharPopup()">Sair</button>
        </div>
    </div>

    <script>
    let currentRow = null;
    let solicitacoes = {{ solicitacoes|tojson|safe }};
    let respostas = {{ respostas|tojson|safe }};

    console.log("Solicita√ß√µes recebidas no frontend:", solicitacoes);
    console.log("Respostas recebidas no frontend:", respostas);

    function aplicarFiltro() {
        const filial = document.getElementById('filial').value;
        window.location.href = `/solicitacoes_loja?filial=${filial}`;
    }

    function updateNotificationCount() {
        const tabela = document.getElementById('tabela-solicitacoes');
        let count = tabela.rows.length;

        for (let row of tabela.rows) {
            const status = row.cells[8].innerText;
            const index = row.rowIndex - 1;
            const solicitacao = solicitacoes[index];
            if (!solicitacao) continue;
            const idSolicitacao = solicitacao.id;
            console.log(`Contando notifica√ß√µes para solicita√ß√£o ID ${idSolicitacao}`);
            const respostasAssociadas = respostas.filter(r => r.solicitacao_id === idSolicitacao);
            console.log(`Respostas associadas ao ID ${idSolicitacao}:`, respostasAssociadas);
            count += respostasAssociadas.length;
            if (status !== 'Pendente') {
                count++;
            }
        }

        document.getElementById('notification-badge').innerText = count;
        console.log(`Total de notifica√ß√µes: ${count}`);
    }

    function toggleNotifications() {
        const panel = document.getElementById('notification-panel');
        const tabela = document.getElementById('tabela-solicitacoes');
        panel.innerHTML = '';

        if (panel.classList.contains('show')) {
            panel.classList.remove('show');
            return;
        }

        for (let row of tabela.rows) {
            const numero = row.cells[0].innerText;
            const status = row.cells[8].innerText;
            const index = row.rowIndex - 1;
            const solicitacao = solicitacoes[index];
            if (!solicitacao) {
                console.log(`Solicita√ß√£o no √≠ndice ${index} n√£o encontrada.`);
                continue;
            }
            console.log(`Processando solicita√ß√£o #${numero} (ID: ${solicitacao.id})`);
            let notificacao = `<div class="notification-item">Solicita√ß√£o #${numero}<br>Solicita√ß√£o enviada - ${solicitacao.descricao || 'Sem descri√ß√£o'}</div>`;

            const idSolicitacao = solicitacao.id;
            const respostasAssociadas = respostas.filter(r => r.solicitacao_id === idSolicitacao);
            console.log(`Respostas para solicita√ß√£o ID ${idSolicitacao}:`, respostasAssociadas);
            if (respostasAssociadas.length > 0) {
                respostasAssociadas.forEach(resposta => {
                    console.log(`Adicionando resposta: ${resposta.mensagem} (${resposta.nome_usuario} - ${resposta.data_hora})`);
                    notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Resposta recebida: ${resposta.mensagem} (${resposta.nome_usuario} - ${resposta.data_hora})</div>`;
                });
            } else {
                notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br><em>Nenhuma resposta recebida.</em></div>`;
            }

            if (status !== 'Pendente') {
                notificacao += `<div class="notification-item">Solicita√ß√£o #${numero}<br>Status alterado para ${status}</div>`;
            }

            panel.innerHTML += notificacao;
        }

        if (panel.innerHTML === '') {
            panel.innerHTML = '<div class="notification-item">Nenhuma notifica√ß√£o dispon√≠vel.</div>';
        }

        panel.classList.add('show');
    }

    function toggleDescricaoBox() {
        const box = document.getElementById('descricao-box');
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
        if (box.style.display === 'block') {
            document.getElementById('descricao-titulo').value = '';
            document.getElementById('descricao-textarea').value = '';
        }
    }

    async function enviarDescricao() {
        const titulo = document.getElementById('descricao-titulo').value.trim();
        const descricao = document.getElementById('descricao-textarea').value.trim();
        if (!titulo || !descricao) {
            alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
            return;
        }

        const filial = document.getElementById('filial').value;
        const tipoSolicitacao = document.getElementById('tipo_solicitacao').value;
        const quantidade = document.getElementById('quantidade').value;

        if (!filial || !tipoSolicitacao || !quantidade) {
            alert('Por favor, preencha todos os campos.');
            return;
        }

        try {
            const response = await fetch('/criar_solicitacao', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filial_id: filial,
                    tipo_solicitacao: tipoSolicitacao,
                    quantidade: quantidade,
                    titulo: titulo,
                    descricao: descricao
                })
            });
            const result = await response.json();
            if (result.success) {
                alert('Solicita√ß√£o enviada com sucesso!');
                document.getElementById('filial').value = '';
                document.getElementById('tipo_solicitacao').value = '';
                document.getElementById('quantidade').value = '';
                document.getElementById('descricao').value = '';
                toggleDescricaoBox();
                window.location.reload();
            } else {
                alert('Erro ao enviar solicita√ß√£o: ' + result.error);
            }
        } catch (error) {
            console.error('Erro ao enviar solicita√ß√£o:', error);
            alert('Erro ao enviar solicita√ß√£o: ' + error.message);
        }
    }

    function abrirPopup(action, row = null) {
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('overlay');
        const respostasList = document.getElementById('respostas-list');
        popup.style.display = 'block';
        overlay.style.display = 'block';

        if (row) {
            const index = row.rowIndex - 1;
            const solicitacao = solicitacoes[index];
            if (solicitacao) {
                document.getElementById('popup-titulo').value = solicitacao.titulo || '';
                document.getElementById('popup-textarea').value = '';
                respostasList.innerHTML = `<p><strong>Descri√ß√£o Inicial:</strong> ${solicitacao.descricao || 'Sem descri√ß√£o'}</p>`;

                const idSolicitacao = solicitacao.id;
                const respostasAssociadas = respostas.filter(r => r.solicitacao_id === idSolicitacao);
                console.log(`Respostas no popup para solicita√ß√£o ID ${idSolicitacao}:`, respostasAssociadas);
                if (respostasAssociadas.length > 0) {
                    respostasAssociadas.forEach(resposta => {
                        respostasList.innerHTML += `<p><strong>Resposta (${resposta.nome_usuario} - ${resposta.data_hora}):</strong> ${resposta.mensagem}</p>`;
                    });
                } else {
                    respostasList.innerHTML += `<p><em>Nenhuma resposta encontrada.</em></p>`;
                }
            } else {
                document.getElementById('popup-titulo').value = '';
                document.getElementById('popup-textarea').value = '';
                respostasList.innerHTML = '';
            }
            currentRow = row;
        } else {
            document.getElementById('popup-titulo').value = '';
            document.getElementById('popup-textarea').value = '';
            respostasList.innerHTML = '';
            currentRow = null;
        }
    }

    function fecharPopup() {
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('overlay');
        popup.style.display = 'none';
        overlay.style.display = 'none';
        document.getElementById('popup-titulo').value = '';
        document.getElementById('popup-textarea').value = '';
        document.getElementById('respostas-list').innerHTML = '';
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && document.getElementById('popup').style.display === 'block') {
            fecharPopup();
        }
    });

    async function enviarPopup() {
        const titulo = document.getElementById('popup-titulo').value.trim();
        const descricao = document.getElementById('popup-textarea').value.trim();
        if (!titulo || !descricao) {
            alert('Por favor, preencha o t√≠tulo e a descri√ß√£o.');
            return;
        }

        if (currentRow) {
            const index = currentRow.rowIndex - 1;
            const id = solicitacoes[index].id;
            try {
                const response = await fetch(`/atualizar_solicitacao/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ titulo, descricao })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Solicita√ß√£o atualizada com sucesso!');
                    fecharPopup();
                    window.location.reload();
                } else {
                    alert('Erro ao atualizar solicita√ß√£o: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao atualizar solicita√ß√£o:', error);
                alert('Erro ao atualizar solicita√ß√£o: ' + error.message);
            }
        } else {
            alert('Selecione uma solicita√ß√£o para atualizar.');
        }
    }

    async function responderPopup() {
        const resposta = document.getElementById('popup-textarea').value.trim();
        if (!resposta) {
            alert('Por favor, digite uma resposta.');
            return;
        }

        if (currentRow) {
            const index = currentRow.rowIndex - 1;
            const id = solicitacoes[index].id;
            try {
                const response = await fetch(`/responder_solicitacao/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resposta })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Resposta enviada com sucesso!');
                    fecharPopup();
                    window.location.reload();
                } else {
                    alert('Erro ao enviar resposta: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao enviar resposta:', error);
                alert('Erro ao enviar resposta: ' + error.message);
            }
        } else {
            alert('Selecione uma solicita√ß√£o para responder.');
        }
    }

    function exportarExcel() {
        const tabela = document.getElementById('tabela-solicitacoes');
        let csv = 'N√∫mero da Solicita√ß√£o,Filial,Tipo de Solicita√ß√£o,Descri√ß√£o,Quantidade,Data/Hora,Matr√≠cula,Nome do Usu√°rio,Status\n';
        for (let row of tabela.rows) {
            let rowData = [];
            for (let cell of row.cells) {
                rowData.push(cell.innerText.replace(/,/g, ';'));
            }
            csv += rowData.join(',') + '\n';
        }
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'solicitacoes.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    window.onload = function() {
        updateNotificationCount();
    };
</script>
</body>
</html>