<!-- <!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crédito e Débito</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .pdf-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pdf-btn:hover {
            background-color: #2980b9;
        }

        .tabs {
            display: flex;
            background-color: white;
            padding: 0.5rem 2rem;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #2980b9;
        }

        .tab-button.active {
            background-color: #27ae60;
        }

        .search-container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #2980b9;
        }

        .clear-button {
            padding: 0.75rem 1.5rem;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .clear-button:hover {
            background-color: #7f8c8d;
        }

        .cards-container {
            max-width: 1200px;
            margin: 1rem auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 0 1rem;
            transition: all 0.3s;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .card p {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .value-verde {
            color: #27ae60;
        }

        .value-vermelho {
            color: #e74c3c;
        }

        .value-neutro {
            color: #95a5a6;
        }

        .chart-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #userChart {
            width: 100% !important;
            height: 250px !important; /* Altura fixa para o gráfico */
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .data-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .user-name {
            color: #3498db;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
        }

        .donut-chart {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }

        .donut-chart .pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: background 0.5s ease;
        }

        .donut-chart .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
        }

        .filter-active .card {
            box-shadow: 0 0 0 2px #3498db;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            background-color: #3498db;
            color: white;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #e74c3c;
        }

        .modal-preview {
            width: 100%;
            height: auto;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-btn.confirm {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #219653;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .card {
                padding: 1rem;
            }
            
            .search-container {
                flex-direction: column;
            }

            .header-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Crédito e Débito</h1>
        <div class="header-buttons">
            <button class="pdf-btn" onclick="openPreview()">Salvar como PDF</button>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="tabs">
        <a href="/conferencia" class="tab-button">Conferente</a>
        <a href="/separador" class="tab-button">Separador</a>
        <a href="/suporte_logistico" class="tab-button">Suporte Logístico</a>
        <a href="/credito_debito" class="tab-button active">Crédito e Débito</a>
    </div>

    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Digite o nome do separador ou conferente...">
        <button class="search-button" onclick="searchUser()">Buscar</button>
        <button class="clear-button" onclick="clearFilter()">Limpar</button>
    </div>

    <div class="chart-container" id="chartContainer">
        <h3 class="chart-title" id="chartTitle">Dados do Usuário</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="cards-container" id="cardsContainer">
        <div class="card">
            <h3>Total de Pedidos <span id="filterBadge" class="badge" style="display: none;">Filtrado</span></h3>
            <p class="value-verde" id="cardPedidos">{{ total_pedidos }}</p>
        </div>
        <div class="card">
            <h3>Total de SKUs 
                <span class="tooltip">ⓘ
                    <span class="tooltiptext">Total de itens conferidos/separados</span>
                </span>
            </h3>
            <p class="value-verde" id="cardSkus">{{ total_skus }}</p>
        </div>
        <div class="card">
            <h3>Pedidos com Divergência</h3>
            <p class="value-vermelho" id="cardComDivergencia">{{ pedidos_com_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Pedidos sem Divergência</h3>
            <p class="value-verde" id="cardSemDivergencia">{{ pedidos_sem_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Comparação Divergências</h3>
            <div class="donut-chart" id="donutChart">
                <div class="pie"></div>
                <div class="center">
                    <span class="value-vermelho" id="percentComDivergencia">{{ (pedidos_com_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                    <span class="value-verde" id="percentSemDivergencia">{{ (pedidos_sem_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Total a Pagar</h3>
            <p class="value-verde" id="cardTotalPagar">R$ {{ total_a_pagar|round(2) }}</p>
        </div>
    </div>

    <div class="data-container">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Pedidos</th>
                    <th>% Acertos</th>
                    <th>Crédito</th>
                    <th>Débito</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td class="user-name" onclick="showUserChart(
                        '{{ usuario.nome }}', 
                        '{{ usuario.tipo }}', 
                        {{ usuario.credito|round(2) }}, 
                        {{ usuario.debito|round(2) }}, 
                        {{ usuario.saldo|round(2) }}, 
                        {{ usuario.total_pedidos }}, 
                        {{ usuario.percentual_acertos|round(2) }},
                        {{ usuario.pedidos_com_divergencia|default(0) }},
                        {{ usuario.pedidos_sem_divergencia|default(0) }},
                        {{ usuario.total_skus|default(0) }}
                    )">
                        {{ usuario.nome }}
                    </td>
                    <td>{{ usuario.tipo }}</td>
                    <td>{{ usuario.total_pedidos }}</td>
                    <td>{{ usuario.percentual_acertos|round(2) }}%</td>
                    <td>R$ {{ usuario.credito|round(2) }}</td>
                    <td>R$ {{ usuario.debito|round(2) }}</td>
                    <td>R$ {{ usuario.saldo|round(2) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <div class="modal" id="pdfPreviewModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePreview()">×</span>
            <h2>Pré-visualização do PDF</h2>
            <div id="pdfPreview" class="modal-preview">
    
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePreview()">Cancelar</button>
                <button class="modal-btn confirm" onclick="generatePDF()">Confirmar e Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let userChart = null;
        let currentFilter = null;
        
        // Dados globais (preenchidos pelo Jinja2)
        const dadosGlobais = {
            total_pedidos: {{ total_pedidos }},
            total_skus: {{ total_skus }},
            pedidos_com_divergencia: {{ pedidos_com_divergencia }},
            pedidos_sem_divergencia: {{ pedidos_sem_divergencia }},
            total_a_pagar: {{ total_a_pagar|round(2) }}
        };

        // Dados dos usuários (preenchidos pelo Jinja2)
        const usuarios = [
            {% for usuario in usuarios %}
            {
                nome: '{{ usuario.nome }}',
                tipo: '{{ usuario.tipo }}',
                credito: {{ usuario.credito|round(2) }},
                debito: {{ usuario.debito|round(2) }},
                saldo: {{ usuario.saldo|round(2) }},
                total_pedidos: {{ usuario.total_pedidos }},
                percentual_acertos: {{ usuario.percentual_acertos|round(2) }},
                pedidos_com_divergencia: {{ usuario.pedidos_com_divergencia|default(0) }},
                pedidos_sem_divergencia: {{ usuario.pedidos_sem_divergencia|default(0) }},
                total_skus: {{ usuario.total_skus|default(0) }}
            },
            {% endfor %}
        ];

        // Inicializa o gráfico de pizza
        function initDivergenciaChart() {
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
        }

        // Atualiza o gráfico de pizza
        function updateDonutChart(comDivergencia, semDivergencia) {
            comDivergencia = Number(comDivergencia) || 0;
            semDivergencia = Number(semDivergencia) || 0;
            
            const total = comDivergencia + semDivergencia;
            let percentCom = 0;
            let percentSem = 100;

            if (total > 0) {
                percentCom = (comDivergencia / total) * 100;
                percentSem = 100 - percentCom;
            }

            const pie = document.querySelector('#donutChart .pie');
            pie.style.background = `conic-gradient(
                #e74c3c 0% ${percentCom}%,
                #27ae60 ${percentCom}% 100%
            )`;
            
            document.getElementById('percentComDivergencia').textContent = `${percentCom.toFixed(1)}%`;
            document.getElementById('percentSemDivergencia').textContent = `${percentSem.toFixed(1)}%`;
        }

        // Aplica o filtro para um usuário específico
        function applyFilter(usuario) {
            currentFilter = usuario;
            document.getElementById('searchInput').value = usuario.nome;
            
            if (usuario.tipo === 'Separador') {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || 0;
                const pedidosComDivergencia = usuario.pedidos_com_divergencia || 0;
                const skusEstimados = usuario.total_skus > 0 ? usuario.total_skus : (usuario.total_pedidos || 0) * 5;

                console.log(`[Separador ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = pedidosComDivergencia;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(pedidosComDivergencia, pedidosSemDivergencia);
            } else {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || (usuario.total_pedidos - (usuario.pedidos_com_divergencia || 0));
                const skusEstimados = usuario.total_skus || (usuario.total_pedidos * 5);

                console.log(`[Conferente ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = usuario.pedidos_com_divergencia || 0;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(usuario.pedidos_com_divergencia || 0, pedidosSemDivergencia);
            }
            
            document.getElementById('filterBadge').style.display = 'inline-block';
            document.getElementById('cardsContainer').classList.add('filter-active');
        }

        // Limpa o filtro atual
        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            
            document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
            document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
            document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
            document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
            document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
            
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
            
            document.getElementById('filterBadge').style.display = 'none';
            document.getElementById('cardsContainer').classList.remove('filter-active');
            
            document.getElementById('chartContainer').style.display = 'none';
        }

        // Busca um usuário pelo nome
        function searchUser() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                clearFilter();
                return;
            }
            
            const usuario = usuarios.find(u => u.nome.toLowerCase().includes(searchTerm));
            if (usuario) {
                applyFilter(usuario);
                showUserChart(
                    usuario.nome,
                    usuario.tipo,
                    usuario.credito,
                    usuario.debito,
                    usuario.saldo,
                    usuario.total_pedidos,
                    usuario.percentual_acertos,
                    usuario.pedidos_com_divergencia,
                    usuario.pedidos_sem_divergencia,
                    usuario.total_skus
                );
            } else {
                alert('Usuário não encontrado!');
            }
        }

        // Mostra o gráfico detalhado do usuário
        function showUserChart(nome, tipo, credito, debito, saldo, total_pedidos, percentual_acertos, pedidos_com_divergencia, pedidos_sem_divergencia, total_skus) {
            const ctx = document.getElementById('userChart').getContext('2d');
            const chartContainer = document.getElementById('chartContainer');
            const chartTitle = document.getElementById('chartTitle');
            
            if (userChart) {
                userChart.destroy();
            }
            
            let labels, data, backgroundColor;
            
            if (tipo === 'Separador') {
                chartTitle.textContent = `Dados de ${nome} - Separador`;
                labels = ['% Acertos', 'Pedidos (30 dias)', 'SKUs Separados', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus > 0 ? total_skus : (total_pedidos || 0) * 5;
                console.log(`[Gráfico Separador ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            } else {
                chartTitle.textContent = `Dados de ${nome} - Conferente`;
                labels = ['% Acertos', 'Pedidos Conferidos', 'SKUs Conferidos', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus || (total_pedidos * 5);
                console.log(`[Gráfico Conferente ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            }
            
            userChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valores',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 250, // Altura fixa para o gráfico
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valores'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.dataIndex === 0) {
                                        return `${label}: ${context.raw}%`;
                                    } else if (context.dataIndex >= 3) {
                                        return `${label}: R$ ${context.raw.toFixed(2)}`;
                                    }
                                    return `${label}: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
            
            chartContainer.style.display = 'block';
            chartContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Função para abrir a pré-visualização
        function openPreview() {
            const previewContent = document.body.cloneNode(true);
            const chartContainer = previewContent.querySelector('#chartContainer');
            if (chartContainer && chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            }
            const previewDiv = document.getElementById('pdfPreview');
            previewDiv.innerHTML = '';
            previewDiv.appendChild(previewContent);

            // Ajustar o tamanho do gráfico na pré-visualização
            const canvas = previewDiv.querySelector('#userChart');
            if (canvas) {
                canvas.style.width = '100%';
                canvas.style.height = '250px'; // Mesmo tamanho definido no CSS
            }

            document.getElementById('pdfPreviewModal').style.display = 'block';
        }

        // Função para fechar a pré-visualização
        function closePreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }

        // Função para gerar e salvar o PDF
        function generatePDF() {
            const element = document.getElementById('pdfPreview').firstChild;
            const opt = {
                margin: 0.3,
                filename: 'credito_debito.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1.5, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                closePreview();
            });
        }

        // Função de logout
        function logout() {
            window.location.href = '/logout';
        }

        // Atualização periódica dos dados
        function updateData() {
            fetch('/atualizar_dados')
                .then(response => response.json())
                .then(data => {
                    if (data.dados_globais) {
                        Object.assign(dadosGlobais, data.dados_globais);
                    }
                    
                    if (data.usuarios) {
                        usuarios = data.usuarios;
                    }
                    
                    if (!currentFilter) {
                        document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
                        document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
                        document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
                        document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
                        document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
                        updateDonutChart(dadosGlobais.pedidos_com_divergencia, dadosGlobais.pedidos_sem_divergencia);
                    }
                    
                    console.log('Dados atualizados com sucesso');
                })
                .catch(error => console.error('Erro ao atualizar dados:', error));
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initDivergenciaChart();
            
            setInterval(updateData, 30000);
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchUser();
            });
        });
    </script>
</body>
</html> -->

<!-- 
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crédito e Débito</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .pdf-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pdf-btn:hover {
            background-color: #2980b9;
        }

        .tabs {
            display: flex;
            background-color: white;
            padding: 0.5rem 2rem;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #2980b9;
        }

        .tab-button.active {
            background-color: #27ae60;
        }

        .search-container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #2980b9;
        }

        .clear-button {
            padding: 0.75rem 1.5rem;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .clear-button:hover {
            background-color: #7f8c8d;
        }

        .cards-container {
            max-width: 1200px;
            margin: 1rem auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 0 1rem;
            transition: all 0.3s;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .card p {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .value-verde {
            color: #27ae60;
        }

        .value-vermelho {
            color: #e74c3c;
        }

        .value-neutro {
            color: #95a5a6;
        }

        .chart-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #userChart {
            width: 100% !important;
            height: 250px !important;
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .data-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        tr {
            display: table-row; /* Garante que as linhas sejam exibidas normalmente */
        }

        tr.hidden {
            display: none; /* Oculta as linhas não filtradas */
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .user-name {
            color: #3498db;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
        }

        .donut-chart {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }

        .donut-chart .pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: background 0.5s ease;
        }

        .donut-chart .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
        }

        .filter-active .card {
            box-shadow: 0 0 0 2px #3498db;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            background-color: #3498db;
            color: white;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #e74c3c;
        }

        .modal-preview {
            width: 100%;
            height: auto;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-btn.confirm {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #219653;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .card {
                padding: 1rem;
            }
            
            .search-container {
                flex-direction: column;
            }

            .header-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Crédito e Débito</h1>
        <div class="header-buttons">
            <button class="pdf-btn" onclick="openPreview()">Salvar como PDF</button>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="tabs">
        <a href="/conferencia" class="tab-button">Conferente</a>
        <a href="/separador" class="tab-button">Separador</a>
        <a href="/suporte_logistico" class="tab-button">Suporte Logístico</a>
        <a href="/credito_debito" class="tab-button active">Crédito e Débito</a>
    </div>

    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Digite o nome do separador ou conferente...">
        <button class="search-button" onclick="searchUser()">Buscar</button>
        <button class="clear-button" onclick="clearFilter()">Limpar</button>
    </div>

    <div class="chart-container" id="chartContainer">
        <h3 class="chart-title" id="chartTitle">Dados do Usuário</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="cards-container" id="cardsContainer">
        <div class="card">
            <h3>Total de Pedidos <span id="filterBadge" class="badge" style="display: none;">Filtrado</span></h3>
            <p class="value-verde" id="cardPedidos">{{ total_pedidos }}</p>
        </div>
        <div class="card">
            <h3>Total de SKUs 
                <span class="tooltip">ⓘ
                    <span class="tooltiptext">Total de itens conferidos/separados</span>
                </span>
            </h3>
            <p class="value-verde" id="cardSkus">{{ total_skus }}</p>
        </div>
        <div class="card">
            <h3>Pedidos com Divergência</h3>
            <p class="value-vermelho" id="cardComDivergencia">{{ pedidos_com_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Pedidos sem Divergência</h3>
            <p class="value-verde" id="cardSemDivergencia">{{ pedidos_sem_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Comparação Divergências</h3>
            <div class="donut-chart" id="donutChart">
                <div class="pie"></div>
                <div class="center">
                    <span class="value-vermelho" id="percentComDivergencia">{{ (pedidos_com_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                    <span class="value-verde" id="percentSemDivergencia">{{ (pedidos_sem_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Total a Pagar</h3>
            <p class="value-verde" id="cardTotalPagar">R$ {{ total_a_pagar|round(2) }}</p>
        </div>
    </div>

    <div class="data-container">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Pedidos</th>
                    <th>% Acertos</th>
                    <th>Crédito</th>
                    <th>Débito</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr data-nome="{{ usuario.nome }}">
                    <td class="user-name" onclick="showUserChart(
                        '{{ usuario.nome }}', 
                        '{{ usuario.tipo }}', 
                        {{ usuario.credito|round(2) }}, 
                        {{ usuario.debito|round(2) }}, 
                        {{ usuario.saldo|round(2) }}, 
                        {{ usuario.total_pedidos }}, 
                        {{ usuario.percentual_acertos|round(2) }},
                        {{ usuario.pedidos_com_divergencia|default(0) }},
                        {{ usuario.pedidos_sem_divergencia|default(0) }},
                        {{ usuario.total_skus|default(0) }}
                    )">
                        {{ usuario.nome }}
                    </td>
                    <td>{{ usuario.tipo }}</td>
                    <td>{{ usuario.total_pedidos }}</td>
                    <td>{{ usuario.percentual_acertos|round(2) }}%</td>
                    <td>R$ {{ usuario.credito|round(2) }}</td>
                    <td>R$ {{ usuario.debito|round(2) }}</td>
                    <td>R$ {{ usuario.saldo|round(2) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

   
    <div class="modal" id="pdfPreviewModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePreview()">×</span>
            <h2>Pré-visualização do PDF</h2>
            <div id="pdfPreview" class="modal-preview">
           
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePreview()">Cancelar</button>
                <button class="modal-btn confirm" onclick="generatePDF()">Confirmar e Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let userChart = null;
        let currentFilter = null;
        
        // Dados globais (preenchidos pelo Jinja2)
        const dadosGlobais = {
            total_pedidos: {{ total_pedidos }},
            total_skus: {{ total_skus }},
            pedidos_com_divergencia: {{ pedidos_com_divergencia }},
            pedidos_sem_divergencia: {{ pedidos_sem_divergencia }},
            total_a_pagar: {{ total_a_pagar|round(2) }}
        };

        // Dados dos usuários (preenchidos pelo Jinja2)
        const usuarios = [
            {% for usuario in usuarios %}
            {
                nome: '{{ usuario.nome }}',
                tipo: '{{ usuario.tipo }}',
                credito: {{ usuario.credito|round(2) }},
                debito: {{ usuario.debito|round(2) }},
                saldo: {{ usuario.saldo|round(2) }},
                total_pedidos: {{ usuario.total_pedidos }},
                percentual_acertos: {{ usuario.percentual_acertos|round(2) }},
                pedidos_com_divergencia: {{ usuario.pedidos_com_divergencia|default(0) }},
                pedidos_sem_divergencia: {{ usuario.pedidos_sem_divergencia|default(0) }},
                total_skus: {{ usuario.total_skus|default(0) }}
            },
            {% endfor %}
        ];

        // Inicializa o gráfico de pizza
        function initDivergenciaChart() {
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
        }

        // Atualiza o gráfico de pizza
        function updateDonutChart(comDivergencia, semDivergencia) {
            comDivergencia = Number(comDivergencia) || 0;
            semDivergencia = Number(semDivergencia) || 0;
            
            const total = comDivergencia + semDivergencia;
            let percentCom = 0;
            let percentSem = 100;

            if (total > 0) {
                percentCom = (comDivergencia / total) * 100;
                percentSem = 100 - percentCom;
            }

            const pie = document.querySelector('#donutChart .pie');
            pie.style.background = `conic-gradient(
                #e74c3c 0% ${percentCom}%,
                #27ae60 ${percentCom}% 100%
            )`;
            
            document.getElementById('percentComDivergencia').textContent = `${percentCom.toFixed(1)}%`;
            document.getElementById('percentSemDivergencia').textContent = `${percentSem.toFixed(1)}%`;
        }

        // Aplica o filtro para um usuário específico
        function applyFilter(usuario) {
            currentFilter = usuario;
            document.getElementById('searchInput').value = usuario.nome;
            
            if (usuario.tipo === 'Separador') {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || 0;
                const pedidosComDivergencia = usuario.pedidos_com_divergencia || 0;
                const skusEstimados = usuario.total_skus > 0 ? usuario.total_skus : (usuario.total_pedidos || 0) * 5;

                console.log(`[Separador ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = pedidosComDivergencia;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(pedidosComDivergencia, pedidosSemDivergencia);
            } else {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || (usuario.total_pedidos - (usuario.pedidos_com_divergencia || 0));
                const skusEstimados = usuario.total_skus || (usuario.total_pedidos * 5);

                console.log(`[Conferente ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = usuario.pedidos_com_divergencia || 0;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(usuario.pedidos_com_divergencia || 0, pedidosSemDivergencia);
            }
            
            document.getElementById('filterBadge').style.display = 'inline-block';
            document.getElementById('cardsContainer').classList.add('filter-active');

            // Filtrar a tabela para mostrar apenas o usuário selecionado
            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                const rowName = row.getAttribute('data-nome');
                if (rowName === usuario.nome) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            }
        }

        // Limpa o filtro atual
        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            
            document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
            document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
            document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
            document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
            document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
            
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
            
            document.getElementById('filterBadge').style.display = 'none';
            document.getElementById('cardsContainer').classList.remove('filter-active');
            
            document.getElementById('chartContainer').style.display = 'none';

            // Mostrar todas as linhas da tabela
            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                row.classList.remove('hidden');
            }
        }

        // Busca um usuário pelo nome
        function searchUser() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                clearFilter();
                return;
            }
            
            const usuario = usuarios.find(u => u.nome.toLowerCase().includes(searchTerm));
            if (usuario) {
                applyFilter(usuario);
                showUserChart(
                    usuario.nome,
                    usuario.tipo,
                    usuario.credito,
                    usuario.debito,
                    usuario.saldo,
                    usuario.total_pedidos,
                    usuario.percentual_acertos,
                    usuario.pedidos_com_divergencia,
                    usuario.pedidos_sem_divergencia,
                    usuario.total_skus
                );
            } else {
                alert('Usuário não encontrado!');
            }
        }

        // Mostra o gráfico detalhado do usuário
        function showUserChart(nome, tipo, credito, debito, saldo, total_pedidos, percentual_acertos, pedidos_com_divergencia, pedidos_sem_divergencia, total_skus) {
            const ctx = document.getElementById('userChart').getContext('2d');
            const chartContainer = document.getElementById('chartContainer');
            const chartTitle = document.getElementById('chartTitle');
            
            if (userChart) {
                userChart.destroy();
            }
            
            let labels, data, backgroundColor;
            
            if (tipo === 'Separador') {
                chartTitle.textContent = `Dados de ${nome} - Separador`;
                labels = ['% Acertos', 'Pedidos (30 dias)', 'SKUs Separados', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus > 0 ? total_skus : (total_pedidos || 0) * 5;
                console.log(`[Gráfico Separador ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            } else {
                chartTitle.textContent = `Dados de ${nome} - Conferente`;
                labels = ['% Acertos', 'Pedidos Conferidos', 'SKUs Conferidos', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus || (total_pedidos * 5);
                console.log(`[Gráfico Conferente ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            }
            
            userChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valores',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 250,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valores'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.dataIndex === 0) {
                                        return `${label}: ${context.raw}%`;
                                    } else if (context.dataIndex >= 3) {
                                        return `${label}: R$ ${context.raw.toFixed(2)}`;
                                    }
                                    return `${label}: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
            
            chartContainer.style.display = 'block';
            chartContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Função para abrir a pré-visualização
        function openPreview() {
            const previewContent = document.body.cloneNode(true);
            const chartContainer = previewContent.querySelector('#chartContainer');
            if (chartContainer && chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            }
            const previewDiv = document.getElementById('pdfPreview');
            previewDiv.innerHTML = '';
            previewDiv.appendChild(previewContent);

            const canvas = previewDiv.querySelector('#userChart');
            if (canvas) {
                canvas.style.width = '100%';
                canvas.style.height = '250px';
            }

            document.getElementById('pdfPreviewModal').style.display = 'block';
        }

        // Função para fechar a pré-visualização
        function closePreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }

        // Função para gerar e salvar o PDF
        function generatePDF() {
            const element = document.getElementById('pdfPreview').firstChild;
            const opt = {
                margin: 0.3,
                filename: 'credito_debito.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1.5, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                closePreview();
            });
        }

        // Função de logout
        function logout() {
            window.location.href = '/logout';
        }

        // Atualização periódica dos dados
        function updateData() {
            fetch('/atualizar_dados')
                .then(response => response.json())
                .then(data => {
                    if (data.dados_globais) {
                        Object.assign(dadosGlobais, data.dados_globais);
                    }
                    
                    if (data.usuarios) {
                        usuarios = data.usuarios;
                    }
                    
                    if (!currentFilter) {
                        document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
                        document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
                        document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
                        document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
                        document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
                        updateDonutChart(dadosGlobais.pedidos_com_divergencia, dadosGlobais.pedidos_sem_divergencia);
                    }
                    
                    console.log('Dados atualizados com sucesso');
                })
                .catch(error => console.error('Erro ao atualizar dados:', error));
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initDivergenciaChart();
            
            setInterval(updateData, 30000);
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchUser();
            });
        });
    </script>
</body>
</html> --> 

<!-- 

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crédito e Débito</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .pdf-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pdf-btn:hover {
            background-color: #2980b9;
        }

        .tabs {
            display: flex;
            background-color: white;
            padding: 0.5rem 2rem;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #2980b9;
        }

        .tab-button.active {
            background-color: #27ae60;
        }

        .search-container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #2980b9;
        }

        .clear-button {
            padding: 0.75rem 1.5rem;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .clear-button:hover {
            background-color: #7f8c8d;
        }

        .cards-container {
            max-width: 1200px;
            margin: 1rem auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 0 1rem;
            transition: all 0.3s;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .card p {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .value-verde {
            color: #27ae60;
        }

        .value-vermelho {
            color: #e74c3c;
        }

        .value-neutro {
            color: #95a5a6;
        }

        .chart-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #userChart {
            width: 100% !important;
            height: 250px !important;
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .data-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        tr {
            display: table-row;
        }

        tr.hidden {
            display: none;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .user-name {
            color: #3498db;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
        }

        .donut-chart {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }

        .donut-chart .pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: background 0.5s ease;
        }

        .donut-chart .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
        }

        .filter-active .card {
            box-shadow: 0 0 0 2px #3498db;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            background-color: #3498db;
            color: white;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #e74c3c;
        }

        .modal-preview {
            width: 100%;
            height: auto;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-btn.confirm {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #219653;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .card {
                padding: 1rem;
            }
            
            .search-container {
                flex-direction: column;
            }

            .header-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Crédito e Débito</h1>
        <div class="header-buttons">
            <button class="pdf-btn" onclick="openPreview()">Salvar como PDF</button>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="tabs">
        <a href="/conferencia" class="tab-button">Conferente</a>
        <a href="/separador" class="tab-button">Separador</a>
        <a href="/suporte_logistico" class="tab-button">Suporte Logístico</a>
        <a href="/credito_debito" class="tab-button active">Crédito e Débito</a>
    </div>

    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Digite o nome do separador ou conferente...">
        <button class="search-button" onclick="searchUser()">Buscar</button>
        <button class="clear-button" onclick="clearFilter()">Limpar</button>
    </div>

    <div class="chart-container" id="chartContainer">
        <h3 class="chart-title" id="chartTitle">Dados do Usuário</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="cards-container" id="cardsContainer">
        <div class="card">
            <h3>Total de Pedidos <span id="filterBadge" class="badge" style="display: none;">Filtrado</span></h3>
            <p class="value-verde" id="cardPedidos">{{ total_pedidos }}</p>
        </div>
        <div class="card">
            <h3>Total de SKUs 
                <span class="tooltip">ⓘ
                    <span class="tooltiptext">Total de itens conferidos/separados</span>
                </span>
            </h3>
            <p class="value-verde" id="cardSkus">{{ total_skus }}</p>
        </div>
        <div class="card">
            <h3>Pedidos com Divergência</h3>
            <p class="value-vermelho" id="cardComDivergencia">{{ pedidos_com_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Pedidos sem Divergência</h3>
            <p class="value-verde" id="cardSemDivergencia">{{ pedidos_sem_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Comparação Divergências</h3>
            <div class="donut-chart" id="donutChart">
                <div class="pie"></div>
                <div class="center">
                    <span class="value-vermelho" id="percentComDivergencia">{{ (pedidos_com_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                    <span class="value-verde" id="percentSemDivergencia">{{ (pedidos_sem_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Total a Pagar</h3>
            <p class="value-verde" id="cardTotalPagar">R$ {{ total_a_pagar|round(2) }}</p>
        </div>
    </div>

    <div class="data-container">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Pedidos</th>
                    <th>% Acertos</th>
                    <th>Crédito</th>
                    <th>Débito</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr data-nome="{{ usuario.nome }}">
                    <td class="user-name" onclick="showUserChart(
                        '{{ usuario.nome }}', 
                        '{{ usuario.tipo }}', 
                        {{ usuario.credito|round(2) }}, 
                        {{ usuario.debito|round(2) }}, 
                        {{ usuario.saldo|round(2) }}, 
                        {{ usuario.total_pedidos }}, 
                        {{ usuario.percentual_acertos|round(2) }},
                        {{ usuario.pedidos_com_divergencia|default(0) }},
                        {{ usuario.pedidos_sem_divergencia|default(0) }},
                        {{ usuario.total_skus|default(0) }}
                    )">
                        {{ usuario.nome }}
                    </td>
                    <td>{{ usuario.tipo }}</td>
                    <td>{{ usuario.total_pedidos }}</td>
                    <td>{{ usuario.percentual_acertos|round(2) }}%</td>
                    <td>R$ {{ usuario.credito|round(2) }}</td>
                    <td>R$ {{ usuario.debito|round(2) }}</td>
                    <td>R$ {{ usuario.saldo|round(2) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <div class="modal" id="pdfPreviewModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePreview()">×</span>
            <h2>Pré-visualização do PDF</h2>
            <div id="pdfPreview" class="modal-preview">
            
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePreview()">Cancelar</button>
                <button class="modal-btn confirm" onclick="generatePDF()">Confirmar e Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let userChart = null;
        let currentFilter = null;
        
        // Dados globais (preenchidos pelo Jinja2)
        const dadosGlobais = {
            total_pedidos: {{ total_pedidos }},
            total_skus: {{ total_skus }},
            pedidos_com_divergencia: {{ pedidos_com_divergencia }},
            pedidos_sem_divergencia: {{ pedidos_sem_divergencia }},
            total_a_pagar: {{ total_a_pagar|round(2) }}
        };

        // Dados dos usuários (preenchidos pelo Jinja2)
        const usuarios = [
            {% for usuario in usuarios %}
            {
                nome: '{{ usuario.nome }}',
                tipo: '{{ usuario.tipo }}',
                credito: {{ usuario.credito|round(2) }},
                debito: {{ usuario.debito|round(2) }},
                saldo: {{ usuario.saldo|round(2) }},
                total_pedidos: {{ usuario.total_pedidos }},
                percentual_acertos: {{ usuario.percentual_acertos|round(2) }},
                pedidos_com_divergencia: {{ usuario.pedidos_com_divergencia|default(0) }},
                pedidos_sem_divergencia: {{ usuario.pedidos_sem_divergencia|default(0) }},
                total_skus: {{ usuario.total_skus|default(0) }}
            },
            {% endfor %}
        ];

        // Inicializa o gráfico de pizza
        function initDivergenciaChart() {
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
        }

        // Atualiza o gráfico de pizza
        function updateDonutChart(comDivergencia, semDivergencia) {
            comDivergencia = Number(comDivergencia) || 0;
            semDivergencia = Number(semDivergencia) || 0;
            
            const total = comDivergencia + semDivergencia;
            let percentCom = 0;
            let percentSem = 100;

            if (total > 0) {
                percentCom = (comDivergencia / total) * 100;
                percentSem = 100 - percentCom;
            }

            const pie = document.querySelector('#donutChart .pie');
            pie.style.background = `conic-gradient(
                #e74c3c 0% ${percentCom}%,
                #27ae60 ${percentCom}% 100%
            )`;
            
            document.getElementById('percentComDivergencia').textContent = `${percentCom.toFixed(1)}%`;
            document.getElementById('percentSemDivergencia').textContent = `${percentSem.toFixed(1)}%`;
        }

        // Aplica o filtro para um usuário específico
        function applyFilter(usuario) {
            currentFilter = usuario;
            document.getElementById('searchInput').value = usuario.nome;
            
            if (usuario.tipo === 'Separador') {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || 0;
                const pedidosComDivergencia = usuario.pedidos_com_divergencia || 0;
                const skusEstimados = usuario.total_skus > 0 ? usuario.total_skus : (usuario.total_pedidos || 0) * 5;

                console.log(`[Separador ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = pedidosComDivergencia;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(pedidosComDivergencia, pedidosSemDivergencia);
            } else {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || (usuario.total_pedidos - (usuario.pedidos_com_divergencia || 0));
                const skusEstimados = usuario.total_skus || (usuario.total_pedidos * 5);

                console.log(`[Conferente ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = usuario.pedidos_com_divergencia || 0;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(usuario.pedidos_com_divergencia || 0, pedidosSemDivergencia);
            }
            
            document.getElementById('filterBadge').style.display = 'inline-block';
            document.getElementById('cardsContainer').classList.add('filter-active');

            // Filtrar a tabela para mostrar apenas o usuário selecionado
            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                const rowName = row.getAttribute('data-nome');
                if (rowName === usuario.nome) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            }
        }

        // Limpa o filtro atual
        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            
            document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
            document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
            document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
            document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
            document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
            
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
            
            document.getElementById('filterBadge').style.display = 'none';
            document.getElementById('cardsContainer').classList.remove('filter-active');
            
            document.getElementById('chartContainer').style.display = 'none';

            // Mostrar todas as linhas da tabela
            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                row.classList.remove('hidden');
            }
        }

        // Busca um usuário pelo nome
        function searchUser() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                clearFilter();
                return;
            }
            
            const usuario = usuarios.find(u => u.nome.toLowerCase().includes(searchTerm));
            if (usuario) {
                applyFilter(usuario);
                showUserChart(
                    usuario.nome,
                    usuario.tipo,
                    usuario.credito,
                    usuario.debito,
                    usuario.saldo,
                    usuario.total_pedidos,
                    usuario.percentual_acertos,
                    usuario.pedidos_com_divergencia,
                    usuario.pedidos_sem_divergencia,
                    usuario.total_skus
                );
            } else {
                alert('Usuário não encontrado!');
            }
        }

        // Mostra o gráfico detalhado do usuário
        function showUserChart(nome, tipo, credito, debito, saldo, total_pedidos, percentual_acertos, pedidos_com_divergencia, pedidos_sem_divergencia, total_skus) {
            const ctx = document.getElementById('userChart').getContext('2d');
            const chartContainer = document.getElementById('chartContainer');
            const chartTitle = document.getElementById('chartTitle');
            
            if (userChart) {
                userChart.destroy();
            }
            
            let labels, data, backgroundColor;
            
            if (tipo === 'Separador') {
                chartTitle.textContent = `Dados de ${nome} - Separador`;
                labels = ['% Acertos', 'Pedidos (30 dias)', 'SKUs Separados', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus > 0 ? total_skus : (total_pedidos || 0) * 5;
                console.log(`[Gráfico Separador ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            } else {
                chartTitle.textContent = `Dados de ${nome} - Conferente`;
                labels = ['% Acertos', 'Pedidos Conferidos', 'SKUs Conferidos', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus || (total_pedidos * 5);
                console.log(`[Gráfico Conferente ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            }
            
            userChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valores',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 250,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valores'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            enabled: true, // Garantir que o tooltip está habilitado
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    let value = context.parsed.y;
                                    let labelText = context.chart.data.labels[context.dataIndex];
                                    if (context.dataIndex === 0) {
                                        return `${labelText}: ${value}%`;
                                    } else if (context.dataIndex >= 3) {
                                        return `${labelText}: R$ ${value.toFixed(2)}`;
                                    }
                                    return `${labelText}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
            
            chartContainer.style.display = 'block';
            chartContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Função para abrir a pré-visualização
        function openPreview() {
            // Criar um contêiner temporário para o conteúdo do PDF
            const tempContainer = document.createElement('div');
            tempContainer.className = 'pdf-content';

            // Clonar o gráfico e a tabela
            const chartContainer = document.getElementById('chartContainer').cloneNode(true);
            const dataContainer = document.querySelector('.data-container').cloneNode(true);

            // Adicionar os elementos clonados ao contêiner temporário
            if (chartContainer.style.display !== 'none') {
                tempContainer.appendChild(chartContainer);
            }
            tempContainer.appendChild(dataContainer);

            // Adicionar ao modal de pré-visualização
            const previewDiv = document.getElementById('pdfPreview');
            previewDiv.innerHTML = '';
            previewDiv.appendChild(tempContainer);

            // Garantir que o gráfico seja renderizado no modal
            const canvas = previewDiv.querySelector('#userChart');
            if (canvas && userChart) {
                canvas.style.width = '100%';
                canvas.style.height = '250px';
                const ctx = canvas.getContext('2d');
                userChart.canvas = canvas; // Reatribuir o canvas ao Chart.js
                userChart.update(); // Forçar atualização do gráfico
            }

            document.getElementById('pdfPreviewModal').style.display = 'block';
        }

        // Função para fechar a pré-visualização
        function closePreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }

        // Função para gerar e salvar o PDF
        function generatePDF() {
            const element = document.getElementById('pdfPreview').querySelector('.pdf-content');
            const canvas = element.querySelector('#userChart');

            // Se o gráfico estiver presente, garantir que ele seja renderizado como imagem
            if (canvas && userChart) {
                const imgData = userChart.toBase64Image(); // Converter o gráfico para imagem
                const img = document.createElement('img');
                img.src = imgData;
                img.style.width = '100%';
                img.style.height = '250px';
                canvas.parentNode.replaceChild(img, canvas); // Substituir o canvas pela imagem
            }

            const opt = {
                margin: 0.5,
                filename: 'credito_debito.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: true
                },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                closePreview();
            }).catch(error => {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar o PDF. Por favor, tente novamente.');
            });
        }

        // Função de logout
        function logout() {
            window.location.href = '/logout';
        }

        // Atualização periódica dos dados
        function updateData() {
            fetch('/atualizar_dados')
                .then(response => response.json())
                .then(data => {
                    if (data.dados_globais) {
                        Object.assign(dadosGlobais, data.dados_globais);
                    }
                    
                    if (data.usuarios) {
                        usuarios = data.usuarios;
                    }
                    
                    if (!currentFilter) {
                        document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
                        document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
                        document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
                        document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
                        document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
                        updateDonutChart(dadosGlobais.pedidos_com_divergencia, dadosGlobais.pedidos_sem_divergencia);
                    }
                    
                    console.log('Dados atualizados com sucesso');
                })
                .catch(error => console.error('Erro ao atualizar dados:', error));
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initDivergenciaChart();
            
            setInterval(updateData, 30000);
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchUser();
            });
        });
    </script>
</body>
</html> -->













<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crédito e Débito</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .pdf-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .pdf-btn:hover {
            background-color: #2980b9;
        }

        .tabs {
            display: flex;
            background-color: white;
            padding: 0.5rem 2rem;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #2980b9;
        }

        .tab-button.active {
            background-color: #27ae60;
        }

        .search-container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #2980b9;
        }

        .clear-button {
            padding: 0.75rem 1.5rem;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .clear-button:hover {
            background-color: #7f8c8d;
        }

        .cards-container {
            max-width: 1200px;
            margin: 1rem auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 0 1rem;
            transition: all 0.3s;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .card p {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .value-verde {
            color: #27ae60;
        }

        .value-vermelho {
            color: #e74c3c;
        }

        .value-neutro {
            color: #95a5a6;
        }

        .chart-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #userChart {
            width: 100% !important;
            height: 250px !important;
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .data-container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
        }

        tr {
            display: table-row;
        }

        tr.hidden {
            display: none;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .user-name {
            color: #3498db;
            cursor: pointer;
            font-weight: 500;
            text-decoration: underline;
        }

        .donut-chart {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }

        .donut-chart .pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: background 0.5s ease;
        }

        .donut-chart .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
        }

        .filter-active .card {
            box-shadow: 0 0 0 2px #3498db;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            background-color: #3498db;
            color: rgb(255, 255, 255);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #e74c3c;
        }

        .modal-preview {
            width: 100%;
            height: auto;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-btn.confirm {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn.confirm:hover {
            background-color: #219653;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.cancel:hover {
            background-color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .card {
                padding: 1rem;
            }
            
            .search-container {
                flex-direction: column;
            }

            .header-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Crédito e Débito</h1>
        <div class="header-buttons">
            <button class="pdf-btn" onclick="openPreview()">Salvar como PDF</button>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="tabs">
        <a href="/conferencia" class="tab-button">Conferente</a>
        <a href="/separador" class="tab-button">Separador</a>
        <a href="/suporte_logistico" class="tab-button">Suporte Logístico</a>
        <a href="/credito_debito" class="tab-button active">Crédito e Débito</a>
    </div>

    <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Digite o nome do separador ou conferente...">
        <button class="search-button" onclick="searchUser()">Buscar</button>
        <button class="clear-button" onclick="clearFilter()">Limpar</button>
    </div>

    <div class="chart-container" id="chartContainer">
        <h3 class="chart-title" id="chartTitle">Dados do Usuário</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="cards-container" id="cardsContainer">
        <div class="card">
            <h3>Total de Pedidos <span id="filterBadge" class="badge" style="display: none;">Filtrado</span></h3>
            <p class="value-verde" id="cardPedidos">{{ total_pedidos }}</p>
        </div>
        <div class="card">
            <h3>Total de SKUs 
                <span class="tooltip">ⓘ
                    <span class="tooltiptext">Total de itens conferidos/separados</span>
                </span>
            </h3>
            <p class="value-verde" id="cardSkus">{{ total_skus }}</p>
        </div>
        <div class="card">
            <h3>Pedidos com Divergência</h3>
            <p class="value-vermelho" id="cardComDivergencia">{{ pedidos_com_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Pedidos sem Divergência</h3>
            <p class="value-verde" id="cardSemDivergencia">{{ pedidos_sem_divergencia }}</p>
        </div>
        <div class="card">
            <h3>Comparação Divergências</h3>
            <div class="donut-chart" id="donutChart">
                <div class="pie"></div>
                <div class="center">
                    <span class="value-vermelho" id="percentComDivergencia">{{ (pedidos_com_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                    <span class="value-verde" id="percentSemDivergencia">{{ (pedidos_sem_divergencia/(pedidos_com_divergencia+pedidos_sem_divergencia)*100)|round(1) if (pedidos_com_divergencia+pedidos_sem_divergencia) > 0 else 0 }}%</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Total a Pagar</h3>
            <p class="value-verde" id="cardTotalPagar">R$ {{ total_a_pagar|round(2) }}</p>
        </div>
    </div>

    <div class="data-container">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Pedidos</th>
                    <th>% Acertos</th>
                    <th>Crédito</th>
                    <th>Débito</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr data-nome="{{ usuario.nome }}">
                    <td class="user-name" onclick="showUserChart(
                        '{{ usuario.nome }}', 
                        '{{ usuario.tipo }}', 
                        {{ usuario.credito|round(2) }}, 
                        {{ usuario.debito|round(2) }}, 
                        {{ usuario.saldo|round(2) }}, 
                        {{ usuario.total_pedidos }}, 
                        {{ usuario.percentual_acertos|round(2) }},
                        {{ usuario.pedidos_com_divergencia|default(0) }},
                        {{ usuario.pedidos_sem_divergencia|default(0) }},
                        {{ usuario.total_skus|default(0) }}
                    )">
                        {{ usuario.nome }}
                    </td>
                    <td>{{ usuario.tipo }}</td>
                    <td>{{ usuario.total_pedidos }}</td>
                    <td>{{ usuario.percentual_acertos|round(2) }}%</td>
                    <td>R$ {{ usuario.credito|round(2) }}</td>
                    <td>R$ {{ usuario.debito|round(2) }}</td>
                    <td>R$ {{ usuario.saldo|round(2) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal de Pré-visualização -->
    <div class="modal" id="pdfPreviewModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePreview()">×</span>
            <h2>Pré-visualização do PDF</h2>
            <div id="pdfPreview" class="modal-preview">
                <!-- Conteúdo da pré-visualização será injetado aqui -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePreview()">Cancelar</button>
                <button class="modal-btn confirm" onclick="generatePDF()">Confirmar e Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let userChart = null;
        let currentFilter = null;
        
        // Dados globais (preenchidos pelo Jinja2)
        const dadosGlobais = {
            total_pedidos: {{ total_pedidos }},
            total_skus: {{ total_skus }},
            pedidos_com_divergencia: {{ pedidos_com_divergencia }},
            pedidos_sem_divergencia: {{ pedidos_sem_divergencia }},
            total_a_pagar: {{ total_a_pagar|round(2) }}
        };

        // Dados dos usuários (preenchidos pelo Jinja2)
        const usuarios = [
            {% for usuario in usuarios %}
            {
                nome: '{{ usuario.nome }}',
                tipo: '{{ usuario.tipo }}',
                credito: {{ usuario.credito|round(2) }},
                debito: {{ usuario.debito|round(2) }},
                saldo: {{ usuario.saldo|round(2) }},
                total_pedidos: {{ usuario.total_pedidos }},
                percentual_acertos: {{ usuario.percentual_acertos|round(2) }},
                pedidos_com_divergencia: {{ usuario.pedidos_com_divergencia|default(0) }},
                pedidos_sem_divergencia: {{ usuario.pedidos_sem_divergencia|default(0) }},
                total_skus: {{ usuario.total_skus|default(0) }}
            },
            {% endfor %}
        ];

        // Inicializa o gráfico de pizza
        function initDivergenciaChart() {
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
        }

        // Atualiza o gráfico de pizza
        function updateDonutChart(comDivergencia, semDivergencia) {
            comDivergencia = Number(comDivergencia) || 0;
            semDivergencia = Number(semDivergencia) || 0;
            
            const total = comDivergencia + semDivergencia;
            let percentCom = 0;
            let percentSem = 100;

            if (total > 0) {
                percentCom = (comDivergencia / total) * 100;
                percentSem = 100 - percentCom;
            }

            const pie = document.querySelector('#donutChart .pie');
            pie.style.background = `conic-gradient(
                #e74c3c 0% ${percentCom}%,
                #27ae60 ${percentCom}% 100%
            )`;
            
            document.getElementById('percentComDivergencia').textContent = `${percentCom.toFixed(1)}%`;
            document.getElementById('percentSemDivergencia').textContent = `${percentSem.toFixed(1)}%`;
        }

        // Aplica o filtro para um usuário específico
        function applyFilter(usuario) {
            currentFilter = usuario;
            document.getElementById('searchInput').value = usuario.nome;
            
            if (usuario.tipo === 'Separador') {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || 0;
                const pedidosComDivergencia = usuario.pedidos_com_divergencia || 0;
                const skusEstimados = usuario.total_skus > 0 ? usuario.total_skus : (usuario.total_pedidos || 0) * 5;

                console.log(`[Separador ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = pedidosComDivergencia;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(pedidosComDivergencia, pedidosSemDivergencia);
            } else {
                const pedidosSemDivergencia = usuario.pedidos_sem_divergencia || (usuario.total_pedidos - (usuario.pedidos_com_divergencia || 0));
                const skusEstimados = usuario.total_skus || (usuario.total_pedidos * 5);

                console.log(`[Conferente ${usuario.nome}] Total SKUs: ${usuario.total_skus}, Estimado: ${skusEstimados}`);

                document.getElementById('cardPedidos').textContent = usuario.total_pedidos || 0;
                document.getElementById('cardSkus').textContent = skusEstimados;
                document.getElementById('cardComDivergencia').textContent = usuario.pedidos_com_divergencia || 0;
                document.getElementById('cardSemDivergencia').textContent = pedidosSemDivergencia;
                document.getElementById('cardTotalPagar').textContent = `R$ ${usuario.saldo > 0 ? usuario.saldo.toFixed(2) : '0.00'}`;
                
                updateDonutChart(usuario.pedidos_com_divergencia || 0, pedidosSemDivergencia);
            }
            
            document.getElementById('filterBadge').style.display = 'inline-block';
            document.getElementById('cardsContainer').classList.add('filter-active');

            // Filtrar a tabela para mostrar apenas o usuário selecionado
            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                const rowName = row.getAttribute('data-nome');
                if (rowName === usuario.nome) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            }
        }

        // Limpa o filtro atual
        function clearFilter() {
            currentFilter = null;
            document.getElementById('searchInput').value = '';
            
            document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
            document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
            document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
            document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
            document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
            
            updateDonutChart(
                dadosGlobais.pedidos_com_divergencia,
                dadosGlobais.pedidos_sem_divergencia
            );
            
            document.getElementById('filterBadge').style.display = 'none';
            document.getElementById('cardsContainer').classList.remove('filter-active');
            
            document.getElementById('chartContainer').style.display = 'none';

            // Mostrar todas as linhas da tabela
            const tbody = document.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            for (let row of rows) {
                row.classList.remove('hidden');
            }
        }

        // Busca um usuário pelo nome
        function searchUser() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                clearFilter();
                return;
            }
            
            const usuario = usuarios.find(u => u.nome.toLowerCase().includes(searchTerm));
            if (usuario) {
                applyFilter(usuario);
                showUserChart(
                    usuario.nome,
                    usuario.tipo,
                    usuario.credito,
                    usuario.debito,
                    usuario.saldo,
                    usuario.total_pedidos,
                    usuario.percentual_acertos,
                    usuario.pedidos_com_divergencia,
                    usuario.pedidos_sem_divergencia,
                    usuario.total_skus
                );
            } else {
                alert('Usuário não encontrado!');
            }
        }

        // Mostra o gráfico detalhado do usuário
        function showUserChart(nome, tipo, credito, debito, saldo, total_pedidos, percentual_acertos, pedidos_com_divergencia, pedidos_sem_divergencia, total_skus) {
            const ctx = document.getElementById('userChart').getContext('2d');
            const chartContainer = document.getElementById('chartContainer');
            const chartTitle = document.getElementById('chartTitle');
            
            if (userChart) {
                userChart.destroy();
            }
            
            let labels, data, backgroundColor;
            
            if (tipo === 'Separador') {
                chartTitle.textContent = `Dados de ${nome} - Separador`;
                labels = ['% Acertos', 'Pedidos (30 dias)', 'SKUs Separados', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus > 0 ? total_skus : (total_pedidos || 0) * 5;
                console.log(`[Gráfico Separador ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            } else {
                chartTitle.textContent = `Dados de ${nome} - Conferente`;
                labels = ['% Acertos', 'Pedidos Conferidos', 'SKUs Conferidos', 'Crédito', 'Débito', 'Saldo'];
                const skusEstimados = total_skus || (total_pedidos * 5);
                console.log(`[Gráfico Conferente ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
                data = [
                    percentual_acertos,
                    total_pedidos,
                    skusEstimados,
                    credito,
                    debito,
                    saldo
                ];
                backgroundColor = [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(26, 188, 156, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ];
            }
            
            userChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valores',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 250,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valores'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    let value = context.parsed.y;
                                    let labelText = context.chart.data.labels[context.dataIndex];
                                    if (context.dataIndex === 0) {
                                        return `${labelText}: ${value}%`;
                                    } else if (context.dataIndex >= 3) {
                                        return `${labelText}: R$ ${value.toFixed(2)}`;
                                    }
                                    return `${labelText}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
            
            chartContainer.style.display = 'block';
            chartContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Função para abrir a pré-visualização
        function openPreview() {
            const tempContainer = document.createElement('div');
            tempContainer.className = 'pdf-content';

            // Clonar o gráfico e a tabela
            const chartContainer = document.getElementById('chartContainer').cloneNode(true);
            const dataContainer = document.querySelector('.data-container').cloneNode(true);

            // Adicionar os elementos clonados ao contêiner temporário
            if (chartContainer.style.display !== 'none') {
                tempContainer.appendChild(chartContainer);
            }
            tempContainer.appendChild(dataContainer);

            const previewDiv = document.getElementById('pdfPreview');
            previewDiv.innerHTML = '';
            previewDiv.appendChild(tempContainer);

            // Garantir que o gráfico seja renderizado no modal
            const canvas = previewDiv.querySelector('#userChart');
            if (canvas && userChart) {
                canvas.style.width = '100%';
                canvas.style.height = '250px';
                const ctx = canvas.getContext('2d');
                userChart.canvas = canvas;
                userChart.update();
            }

            document.getElementById('pdfPreviewModal').style.display = 'block';
        }

        // Função para fechar a pré-visualização
        function closePreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }

   
    // Variável para armazenar os dados do gráfico atual
    let currentChartData = null;

    // Função para abrir a pré-visualização
    function openPreview() {
        const tempContainer = document.createElement('div');
        tempContainer.className = 'pdf-content';
        tempContainer.style.height = 'auto'; // Altura automática com limite mínimo
        tempContainer.style.minHeight = '600px'; // Altura mínima para evitar colapso

        // Clonar o gráfico, os cards e a tabela na ordem desejada
        const chartContainer = document.getElementById('chartContainer').cloneNode(true);
        const cardsContainer = document.getElementById('cardsContainer').cloneNode(true);
        const dataContainer = document.querySelector('.data-container').cloneNode(true);

        // Adicionar os elementos clonados ao contêiner temporário na ordem: gráfico, cards, tabela
        if (chartContainer.style.display !== 'none') {
            tempContainer.appendChild(chartContainer); // Primeiro o gráfico
        }
        tempContainer.appendChild(cardsContainer); // Depois os cards
        tempContainer.appendChild(dataContainer); // Por último a tabela

        const previewDiv = document.getElementById('pdfPreview');
        previewDiv.innerHTML = '';
        previewDiv.style.height = 'auto'; // Altura automática
        previewDiv.style.minHeight = '600px'; // Altura mínima para o modal
        previewDiv.style.overflow = 'auto'; // Permitir rolagem se necessário
        previewDiv.appendChild(tempContainer);

        // Re-renderizar o gráfico no modal
        const canvas = previewDiv.querySelector('#userChart');
        if (canvas && currentChartData) {
            console.log('Re-renderizando gráfico no modal...');
            canvas.style.width = '100%';
            canvas.style.height = '250px';
            const ctx = canvas.getContext('2d');
            
            if (userChart) {
                userChart.destroy();
            }

            userChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: currentChartData.labels,
                    datasets: [{
                        label: 'Valores',
                        data: currentChartData.data,
                        backgroundColor: currentChartData.backgroundColor,
                        borderColor: currentChartData.backgroundColor.map(color => color.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 250,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valores'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    let value = context.parsed.y;
                                    let labelText = context.chart.data.labels[context.dataIndex];
                                    if (context.dataIndex === 0) {
                                        return `${labelText}: ${value}%`;
                                    } else if (context.dataIndex >= 3) {
                                        return `${labelText}: R$ ${value.toFixed(2)}`;
                                    }
                                    return `${labelText}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.log('Nenhum dado de gráfico disponível para re-renderizar.');
        }

        document.getElementById('pdfPreviewModal').style.display = 'block';
    }

    // Função para fechar a pré-visualização
    function closePreview() {
        document.getElementById('pdfPreviewModal').style.display = 'none';
    }

    // Função ajustada para gerar e salvar o PDF
    function generatePDF() {
        const element = document.getElementById('pdfPreview').querySelector('.pdf-content');
        const canvas = element.querySelector('#userChart');

        setTimeout(() => {
            try {
                if (canvas && userChart) {
                    console.log('Convertendo gráfico em imagem...');
                    userChart.update();
                    const imgData = userChart.toBase64Image();
                    if (!imgData) {
                        throw new Error('Falha ao converter o gráfico em imagem.');
                    }
                    console.log('Gráfico convertido em imagem com sucesso.');
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.style.width = '100%';
                    img.style.height = '250px';
                    canvas.parentNode.replaceChild(img, canvas);
                } else {
                    console.log('Nenhum gráfico presente para converter.');
                }

                const opt = {
                    margin: 0.5,
                    filename: 'credito_debito.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: true,
                        windowWidth: 1200,
                        windowHeight: element.scrollHeight, // Usar a altura real do elemento
                        scrollX: 0,
                        scrollY: 0
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } // Mudar para 'letter' para mais espaço
                };

                console.log('Iniciando geração do PDF...');
                html2pdf().set(opt).from(element).save().then(() => {
                    console.log('PDF gerado com sucesso.');
                    closePreview();
                }).catch(error => {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Erro ao gerar o PDF: ' + error.message + '. Verifique o console para mais detalhes.');
                });
            } catch (error) {
                console.error('Erro durante o processo de geração do PDF:', error);
                alert('Erro ao preparar o PDF: ' + error.message + '. Verifique o console para mais detalhes.');
            }
        }, 1500);
    }

    // Ajuste na função showUserChart para armazenar os dados do gráfico
    function showUserChart(nome, tipo, credito, debito, saldo, total_pedidos, percentual_acertos, pedidos_com_divergencia, pedidos_sem_divergencia, total_skus) {
        const ctx = document.getElementById('userChart').getContext('2d');
        const chartContainer = document.getElementById('chartContainer');
        const chartTitle = document.getElementById('chartTitle');
        
        if (userChart) {
            userChart.destroy();
        }
        
        let labels, data, backgroundColor;
        
        if (tipo === 'Separador') {
            chartTitle.textContent = `Dados de ${nome} - Separador`;
            labels = ['% Acertos', 'Pedidos (30 dias)', 'SKUs Separados', 'Crédito', 'Débito', 'Saldo'];
            const skusEstimados = total_skus > 0 ? total_skus : (total_pedidos || 0) * 5;
            console.log(`[Gráfico Separador ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
            data = [
                percentual_acertos,
                total_pedidos,
                skusEstimados,
                credito,
                debito,
                saldo
            ];
            backgroundColor = [
                'rgba(52, 152, 219, 0.7)',
                'rgba(155, 89, 182, 0.7)',
                'rgba(26, 188, 156, 0.7)',
                'rgba(46, 204, 113, 0.7)',
                'rgba(231, 76, 60, 0.7)',
                'rgba(241, 196, 15, 0.7)'
            ];
        } else {
            chartTitle.textContent = `Dados de ${nome} - Conferente`;
            labels = ['% Acertos', 'Pedidos Conferidos', 'SKUs Conferidos', 'Crédito', 'Débito', 'Saldo'];
            const skusEstimados = total_skus || (total_pedidos * 5);
            console.log(`[Gráfico Conferente ${nome}] Total SKUs: ${total_skus}, Estimado: ${skusEstimados}`);
            data = [
                percentual_acertos,
                total_pedidos,
                skusEstimados,
                credito,
                debito,
                saldo
            ];
            backgroundColor = [
                'rgba(52, 152, 219, 0.7)',
                'rgba(155, 89, 182, 0.7)',
                'rgba(26, 188, 156, 0.7)',
                'rgba(46, 204, 113, 0.7)',
                'rgba(231, 76, 60, 0.7)',
                'rgba(241, 196, 15, 0.7)'
            ];
        }
        
        currentChartData = {
            labels: labels,
            data: data,
            backgroundColor: backgroundColor
        };

        userChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Valores',
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: backgroundColor.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                height: 250,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valores'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let value = context.parsed.y;
                                let labelText = context.chart.data.labels[context.dataIndex];
                                if (context.dataIndex === 0) {
                                    return `${labelText}: ${value}%`;
                                } else if (context.dataIndex >= 3) {
                                    return `${labelText}: R$ ${value.toFixed(2)}`;
                                }
                                return `${labelText}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
        
        chartContainer.style.display = 'block';
        chartContainer.scrollIntoView({ behavior: 'smooth' });
    }


        // Função de logout
        function logout() {
            window.location.href = '/logout';
        }

        // Atualização periódica dos dados
        function updateData() {
            fetch('/atualizar_dados')
                .then(response => response.json())
                .then(data => {
                    if (data.dados_globais) {
                        Object.assign(dadosGlobais, data.dados_globais);
                    }
                    
                    if (data.usuarios) {
                        usuarios = data.usuarios;
                    }
                    
                    if (!currentFilter) {
                        document.getElementById('cardPedidos').textContent = dadosGlobais.total_pedidos;
                        document.getElementById('cardSkus').textContent = dadosGlobais.total_skus;
                        document.getElementById('cardComDivergencia').textContent = dadosGlobais.pedidos_com_divergencia;
                        document.getElementById('cardSemDivergencia').textContent = dadosGlobais.pedidos_sem_divergencia;
                        document.getElementById('cardTotalPagar').textContent = `R$ ${dadosGlobais.total_a_pagar.toFixed(2)}`;
                        updateDonutChart(dadosGlobais.pedidos_com_divergencia, dadosGlobais.pedidos_sem_divergencia);
                    }
                    
                    console.log('Dados atualizados com sucesso');
                })
                .catch(error => console.error('Erro ao atualizar dados:', error));
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initDivergenciaChart();
            
            setInterval(updateData, 30000);
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchUser();
            });
        });
    </script>
</body>
</html>